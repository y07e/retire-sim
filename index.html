<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë‚˜ì˜ ì€í‡´ ì‹œë®¬ë ˆì´í„° Ver.1.0</title>

<!-- PWA ë©”íƒ€íƒœê·¸ -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ì€í‡´ì‹œë®¬">
<link rel="apple-touch-icon" href="icons/icon-512.png">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
<meta name="description" content="ì€í‡´ í›„ ìì‚° ê´€ë¦¬, í˜„ê¸ˆ íë¦„ ì‹œë®¬ë ˆì´ì…˜">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #f0f2f5;
  --card: #ffffff;
  --text: #1a1a2e;
  --text2: #555;
  --border: #e0e0e0;
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --accent: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --radius: 12px;
}
.dark {
  --bg: #0f172a;
  --card: #1e293b;
  --text: #e2e8f0;
  --text2: #94a3b8;
  --border: #334155;
  --primary: #3b82f6;
  --primary-light: #1e3a5f;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}
.header {
  background: linear-gradient(135deg, #1e40af, #3b82f6);
  color: white;
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,0.15);
}
.header-title { flex: 1; text-align: center; }
.header h1 { font-size: 1.6rem; font-weight: 700; margin: 0; letter-spacing: 1px; }
.header-sub { font-size: 0.8rem; opacity: 0.85; margin: 2px 0 0; font-weight: 400; }
.header-right { display: flex; gap: 12px; align-items: center; }
.app-footer {
  background: linear-gradient(135deg, #1e40af, #3b82f6);
  color: white;
  padding: 18px 24px;
  text-align: center;
  margin-top: 24px;
  border-radius: 12px;
}
.app-footer .footer-quote {
  font-style: italic;
  font-size: 0.88rem;
  opacity: 0.92;
  line-height: 1.5;
  margin-bottom: 10px;
}
.app-footer .footer-author {
  font-size: 0.72rem;
  opacity: 0.65;
  margin-top: 8px;
}
.app-footer .footer-copy {
  font-size: 0.75rem;
  opacity: 0.8;
  margin-top: 2px;
}
.theme-toggle {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.1rem;
}
.theme-toggle:hover { background: rgba(255,255,255,0.3); }
.tab-nav {
  display: flex;
  background: var(--card);
  border-bottom: 2px solid var(--border);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.tab-nav button {
  flex: 1;
  min-width: 140px;
  padding: 14px 20px;
  border: none;
  background: none;
  color: var(--text2);
  font-size: 0.95rem;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}
.tab-nav button:hover { color: var(--primary); background: var(--primary-light); }
.tab-nav button.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
  font-weight: 700;
}
.tab-content { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; }
.tab-content.active { display: block; }
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}
.card h2 {
  font-size: 1.1rem;
  font-weight: 700;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--primary);
  display: flex;
  align-items: center;
  gap: 8px;
}
.card h3 {
  font-size: 0.95rem;
  font-weight: 600;
  margin: 12px 0 8px;
  color: var(--primary);
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}
.form-group { display: flex; flex-direction: column; gap: 4px; }
.form-group label {
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--text2);
}
.form-group input, .form-group select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 0.9rem;
  background: var(--bg);
  color: var(--text);
  transition: border 0.2s;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
}
.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
.btn-accent { background: var(--accent); color: white; }
.btn-accent:hover { background: #059669; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #dc2626; }
.btn-warning { background: var(--warning); color: white; }
.btn-sm { padding: 5px 10px; font-size: 0.78rem; }
.btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
  margin-top: 8px;
}
th, td {
  padding: 8px 10px;
  text-align: right;
  border-bottom: 1px solid var(--border);
}
th {
  background: var(--primary-light);
  font-weight: 600;
  position: sticky;
  top: 0;
}
td:first-child, th:first-child { text-align: left; }
tr:hover td { background: var(--primary-light); }
.table-wrap { overflow-x: auto; max-height: 500px; overflow-y: auto; }
.chart-container {
  position: relative;
  width: 100%;
  max-height: 400px;
  margin: 16px 0;
}
.profile-banner {
  display: flex;
  gap: 16px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.profile-card {
  flex: 1;
  min-width: 240px;
  background: var(--card);
  border-radius: 14px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid var(--border);
}
.profile-avatar {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.6rem;
  flex-shrink: 0;
}
.profile-info { flex: 1; }
.profile-info .p-nickname {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text);
}
.profile-info .p-name {
  font-size: 0.8rem;
  color: var(--text2);
  margin-top: 1px;
}
.profile-info .p-detail {
  font-size: 0.82rem;
  color: var(--text2);
  margin-top: 4px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.profile-info .p-detail span {
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.78rem;
}
.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}
.summary-card {
  background: linear-gradient(135deg, var(--primary), #6366f1);
  color: white;
  padding: 16px;
  border-radius: var(--radius);
  text-align: center;
}
.summary-card.green { background: linear-gradient(135deg, #059669, #10b981); }
.summary-card.orange { background: linear-gradient(135deg, #d97706, #f59e0b); }
.summary-card.red { background: linear-gradient(135deg, #dc2626, #ef4444); }
.summary-card.teal { background: linear-gradient(135deg, #0d9488, #14b8a6); }
.summary-card.purple { background: linear-gradient(135deg, #7c3aed, #a78bfa); }
.summary-card.sky { background: linear-gradient(135deg, #0284c7, #38bdf8); }
.summary-card.rose { background: linear-gradient(135deg, #be123c, #fb7185); }
.summary-card.amber { background: linear-gradient(135deg, #b45309, #fbbf24); }
.summary-card.indigo { background: linear-gradient(135deg, #4338ca, #818cf8); }
.summary-card.emerald { background: linear-gradient(135deg, #047857, #34d399); }
.summary-card .label { font-size: 0.8rem; opacity: 0.9; }
.summary-card .value { font-size: 1.4rem; font-weight: 700; margin-top: 4px; }
.income-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  position: relative;
}
.income-item.editable { cursor: pointer; transition: background 0.15s; }
.income-item.editable:hover { background: var(--primary-light); }
.income-item .delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 2px 6px;
  border-radius: 4px;
}
.income-item .delete-btn:hover { background: rgba(239,68,68,0.1); }
.account-tabs {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}
.account-tab {
  padding: 8px 16px;
  border: 2px solid var(--border);
  border-radius: 20px;
  background: var(--bg);
  color: var(--text);
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}
.account-tab.active {
  border-color: var(--primary);
  background: var(--primary);
  color: white;
}
.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.num-positive { color: #10b981; font-weight: 600; }
.num-negative { color: #ef4444; font-weight: 600; }
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 200;
  justify-content: center;
  align-items: center;
}
.modal-overlay.show { display: flex; }
.modal {
  background: var(--card);
  border-radius: var(--radius);
  padding: 24px;
  max-width: 500px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}
.modal h3 { margin-bottom: 16px; font-size: 1.1rem; }
.toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--accent);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  z-index: 300;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.3s;
}
.toast.show { transform: translateY(0); opacity: 1; }
@media (max-width: 768px) {
  .header h1 { font-size: 1.15rem; }
  .header-sub { font-size: 0.7rem; }
  .tab-nav button { min-width: 100px; padding: 10px 12px; font-size: 0.82rem; }
  .tab-content { padding: 12px; }
  .form-grid { grid-template-columns: 1fr 1fr; }
  .two-col { grid-template-columns: 1fr; }
  .summary-cards { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
  .form-grid { grid-template-columns: 1fr; }
  .summary-cards { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    <h1>ë‚˜ì˜ ì€í‡´ ì‹œë®¬ë ˆì´í„° <span style="font-size:0.45em;font-weight:400;opacity:0.7;letter-spacing:0;">by ì«‘ì•„ë¹ </span></h1>
    <p class="header-sub">(ì€í‡´ í›„ ìì‚° ê´€ë¦¬, í˜„ê¸ˆ íë¦„ ì‹œë®¬ë ˆì´ì…˜) Ver.1.0</p>
  </div>
  <div class="header-right">
    <button class="theme-toggle" onclick="toggleTheme()" title="ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ">ğŸŒ™</button>
  </div>
</div>

<nav class="tab-nav">
  <button class="active" onclick="switchTab('cashflow')">ğŸ’° ì›” í˜„ê¸ˆ íë¦„</button>
  <button onclick="switchTab('portfolio')">ğŸ“Š ìì‚° í¬íŠ¸í´ë¦¬ì˜¤</button>
  <button onclick="switchTab('accounts')">ğŸ“‹ ê³„ì¢Œë³„ í¬íŠ¸í´ë¦¬ì˜¤</button>
  <button onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</button>
</nav>

<!-- ===== íƒ­ 1: ì›” í˜„ê¸ˆ íë¦„ ===== -->
<div id="tab-cashflow" class="tab-content active">
  <div id="profile-banner" class="profile-banner"></div>
  <div class="summary-cards" id="cashflow-summary"></div>

  <div class="card">
    <h2>ğŸ“¥ ìˆ˜ì…ì› ê´€ë¦¬</h2>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addIncome('pension')">+ ì—°ê¸ˆ ì¶”ê°€</button>
      <button class="btn btn-accent" onclick="addIncome('investment')">+ íˆ¬ììˆ˜ì… ì¶”ê°€</button>
      <button class="btn btn-warning" onclick="addIncome('other')">+ ê¸°íƒ€ìˆ˜ì… ì¶”ê°€</button>
    </div>
    <div id="income-list"></div>
  </div>

  <div class="card">
    <h2>ğŸ“¤ ì§€ì¶œ ê´€ë¦¬</h2>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addExpense()">+ ì§€ì¶œí•­ëª© ì¶”ê°€</button>
    </div>
    <div id="expense-list"></div>
  </div>

  <div class="card">
    <h2>ğŸ“Š ë‚˜ì´ëŒ€ë³„ ì›” í˜„ê¸ˆíë¦„ (ìˆ˜ì…/ì§€ì¶œ)</h2>
    <div class="btn-group">
      <button class="btn btn-primary btn-sm" onclick="calculateCashflow()">ì°¨íŠ¸ ê°±ì‹ </button>
    </div>
    <div class="chart-container" style="height:380px;max-height:500px;">
      <canvas id="cashflow-chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“ˆ ì›” í˜„ê¸ˆíë¦„ ì¶”ì´</h2>
    <div class="chart-container" style="height:380px;max-height:500px;">
      <canvas id="netcashflow-chart"></canvas>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ“‹ ë‚˜ì´ëŒ€ë³„ ì›” í˜„ê¸ˆíë¦„ ìƒì„¸</h2>
    <div class="table-wrap" id="cashflow-table-wrap"></div>
  </div>
  <div class="app-footer" id="footer-tab1"></div>
</div>

<!-- ===== íƒ­ 2: ìì‚° í¬íŠ¸í´ë¦¬ì˜¤ ===== -->
<div id="tab-portfolio" class="tab-content">
  <div class="summary-cards" id="asset-summary"></div>

  <div class="card">
    <h2>ğŸ¦ ìì‚° ì…ë ¥</h2>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addAsset()">+ ìì‚° ì¶”ê°€</button>
    </div>
    <div id="asset-list"></div>
  </div>

  <div class="two-col" id="asset-charts-row" style="align-items:stretch;">
    <div class="card" style="display:flex;flex-direction:column;">
      <h2>ğŸ¥§ ìì‚° ë¹„ìœ¨</h2>
      <div id="asset-pie-wrap" style="flex:1;display:flex;align-items:center;justify-content:center;min-height:200px;">
        <canvas id="asset-pie-chart"></canvas>
      </div>
    </div>
    <div class="card" id="asset-breakdown-card">
      <h2>ğŸ“Š ìì‚° í˜„í™© <span id="asset-date-label" style="font-size:0.75rem;font-weight:500;color:var(--text2);"></span></h2>
      <div id="asset-breakdown"></div>
    </div>
  </div>
  <div class="app-footer" id="footer-tab2"></div>
</div>

<!-- ===== íƒ­ 3: ê³„ì¢Œë³„ í¬íŠ¸í´ë¦¬ì˜¤ ===== -->
<div id="tab-accounts" class="tab-content">
  <div class="card">
    <h2>ğŸ“‚ ê³„ì¢Œ ê´€ë¦¬</h2>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="addAccount()">+ ê³„ì¢Œ ì¶”ê°€</button>
    </div>
    <div class="account-tabs" id="account-tabs"></div>
  </div>

  <div id="account-detail" style="display:none;">
    <div class="card">
      <h2 id="account-detail-title">ì¢…ëª© ê´€ë¦¬</h2>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="addHolding()">+ ì¢…ëª© ì¶”ê°€</button>
        <button class="btn btn-sm" style="background:#10b981;color:white;" onclick="fetchCurrentPrices()" id="btn-fetch-prices">ğŸ“¡ í˜„ì¬ê°€ ê°±ì‹ </button>
        <button class="btn btn-primary btn-sm" onclick="editAccount()">ê³„ì¢Œ ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCurrentAccount()">ê³„ì¢Œ ì‚­ì œ</button>
      </div>
      <div id="price-update-status" style="font-size:0.78rem;color:var(--text2);margin:4px 0 8px;display:none;"></div>
      <div class="table-wrap">
        <table id="holdings-table">
          <thead>
            <tr>
              <th>ì¢…ëª©ëª…</th>
              <th>ë§¤ìˆ˜ë‹¨ê°€</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>í˜„ì¬ê°€</th>
              <th>í‰ê°€ê¸ˆì•¡</th>
              <th>ìˆ˜ìµë¥ </th>
              <th>ë°°ë‹¹ë¥ (%)</th>
              <th>ì—°ë°°ë‹¹ê¸ˆ</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="holdings-body"></tbody>
          <tfoot id="holdings-foot"></tfoot>
        </table>
      </div>
    </div>

  </div>

  <div class="two-col">
    <div class="card">
      <h2>ğŸ¥§ ì „ì²´ ì¢…ëª© ë¹„ìœ¨</h2>
      <div class="chart-container" style="max-height:400px;">
        <canvas id="holdings-pie-chart"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>ğŸ“Š ì¢…ëª©ë³„ ìˆ˜ìµë¥  <span style="font-size:0.75rem;font-weight:500;color:var(--text2);">TOP 10</span></h2>
      <div class="chart-container" style="max-height:450px;min-height:320px;">
        <canvas id="holdings-bar-chart"></canvas>
      </div>
    </div>
  </div>

  <div class="two-col">
    <div class="card">
      <h2>ğŸ’° ë¶„ê¸°ë³„ ë°°ë‹¹ê¸ˆ <span style="font-size:0.75rem;font-weight:500;color:var(--text2);">(ë¶€ë¶€ í•©ì‚°)</span></h2>
      <div id="div-quarterly-total" style="text-align:center;font-size:1.3rem;font-weight:700;color:var(--primary);margin:8px 0;"></div>
      <div class="chart-container" style="max-height:400px;">
        <canvas id="dividend-quarterly-chart"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>ğŸ“… ì›”ë³„ ë°°ë‹¹ê¸ˆ <span style="font-size:0.75rem;font-weight:500;color:var(--text2);">(ë¶€ë¶€ í•©ì‚°)</span></h2>
      <div id="div-monthly-total" style="text-align:center;font-size:1.3rem;font-weight:700;color:var(--primary);margin:8px 0;"></div>
      <div class="chart-container" style="max-height:400px;">
        <canvas id="dividend-monthly-chart"></canvas>
      </div>
    </div>
  </div>
  <div class="app-footer" id="footer-tab3"></div>
</div>

<!-- ===== íƒ­ 4: ì„¤ì • ===== -->
<div id="tab-settings" class="tab-content">

  <div class="card">
    <h2>ğŸ‘¤ ë³¸ì¸ í”„ë¡œí•„</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>ì´ë¦„</label>
        <input type="text" id="set-owner-name" placeholder="ì˜ˆ: í™ê¸¸ë™">
      </div>
      <div class="form-group">
        <label>ë³„ëª…</label>
        <input type="text" id="set-owner-nickname" placeholder="ì˜ˆ: ì«‘ì•„ë¹ ">
      </div>
      <div class="form-group">
        <label>ì„±ë³„</label>
        <select id="set-owner-gender">
          <option value="male">ë‚¨ì„± ğŸ‘¨</option>
          <option value="female">ì—¬ì„± ğŸ‘©</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì¶œìƒì—°ë„</label>
        <input type="number" id="set-owner-birthyear" value="1970" min="1940" max="2010" step="1">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>ğŸ‘« ë°°ìš°ì í”„ë¡œí•„</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>ì´ë¦„</label>
        <input type="text" id="set-spouse-name" placeholder="ì˜ˆ: ê¹€ì˜í¬">
      </div>
      <div class="form-group">
        <label>ë³„ëª…</label>
        <input type="text" id="set-spouse-nickname" placeholder="ì˜ˆ: ì‚¬ì">
      </div>
      <div class="form-group">
        <label>ì„±ë³„</label>
        <select id="set-spouse-gender">
          <option value="male">ë‚¨ì„± ğŸ‘¨</option>
          <option value="female">ì—¬ì„± ğŸ‘©</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì¶œìƒì—°ë„</label>
        <input type="number" id="set-spouse-birthyear" value="1972" min="1940" max="2010" step="1">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>âš™ï¸ ê¸°ë³¸ ì„¤ì •</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>ì€í‡´ ì˜ˆì • ì—°ë„</label>
        <input type="number" id="set-retireyear" value="2029" min="2024" max="2060" step="1">
      </div>
      <div class="form-group">
        <label>ë¬¼ê°€ìƒìŠ¹ë¥  (%)</label>
        <input type="number" id="set-inflation" value="2.0" step="0.1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ ì„±ì¥ë¥  (%)</label>
        <input type="number" id="set-divgrowth" value="2.5" step="0.1">
      </div>
      <div class="form-group">
        <label>ì—°ê¸ˆì†Œë“ì„¸ìœ¨ (%)</label>
        <input type="number" id="set-pensiontax" value="3.3" step="0.1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ì†Œë“ì„¸ìœ¨ (%)</label>
        <input type="number" id="set-divtax" value="15.4" step="0.1">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
    </div>
  </div>

  <!-- ë°ì´í„° ê´€ë¦¬ -->
  <div class="card">
    <h2>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h2>
    <div style="font-size:0.85rem; line-height:1.6; color:var(--text2); margin-bottom:16px;">
      ëª¨ë“  ë°ì´í„°ëŠ” <strong style="color:var(--text);">ë¸Œë¼ìš°ì € LocalStorage</strong>ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤.<br>
      ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ ì‹œ ë°ì´í„°ê°€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, <strong style="color:var(--primary);">ì •ê¸°ì ì¸ ë°±ì—…ì„ ê¶Œì¥</strong>í•©ë‹ˆë‹¤.
    </div>

    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px;">
      <!-- ë°±ì—… -->
      <div style="border:1px solid var(--border); border-radius:10px; padding:16px; background:var(--primary-light);">
        <div style="font-weight:700; font-size:0.95rem; margin-bottom:6px;">ğŸ“¤ ë°ì´í„° ë°±ì—… (ë‚´ë³´ë‚´ê¸°)</div>
        <div style="font-size:0.8rem; color:var(--text2); margin-bottom:12px; line-height:1.5;">
          í˜„ì¬ ì…ë ¥ëœ ëª¨ë“  ë°ì´í„°ë¥¼ JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.<br>
          íŒŒì¼ëª… ì˜ˆì‹œ: <code style="font-size:0.75rem; background:var(--border); padding:1px 5px; border-radius:3px;">ì€í‡´ìì‚°ê´€ë¦¬_2026-02-27.json</code>
        </div>
        <button class="btn btn-primary btn-sm" onclick="exportData()" style="width:100%;">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸° (JSON)</button>
      </div>

      <!-- ë³µì› -->
      <div style="border:1px solid var(--border); border-radius:10px; padding:16px;">
        <div style="font-weight:700; font-size:0.95rem; margin-bottom:6px;">ğŸ“¥ ë°ì´í„° ë³µì› (ê°€ì ¸ì˜¤ê¸°)</div>
        <div style="font-size:0.8rem; color:var(--text2); margin-bottom:12px; line-height:1.5;">
          ì´ì „ì— ë°±ì—…í•œ JSON íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ ë°ì´í„°ë¥¼ ë³µì›í•©ë‹ˆë‹¤.<br>
          ê¸°ì¡´ ë°ì´í„°ì— <strong>ë®ì–´ì“°ê¸°</strong> ë˜ë¯€ë¡œ ì£¼ì˜í•˜ì„¸ìš”.
        </div>
        <button class="btn btn-accent btn-sm" onclick="document.getElementById('import-file').click()" style="width:100%;">ğŸ“¥ JSON íŒŒì¼ ì„ íƒ</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
      </div>

      <!-- ì´ˆê¸°í™” -->
      <div style="border:1px solid var(--danger); border-radius:10px; padding:16px; background:rgba(239,68,68,0.04);">
        <div style="font-weight:700; font-size:0.95rem; margin-bottom:6px; color:var(--danger);">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</div>
        <div style="font-size:0.8rem; color:var(--text2); margin-bottom:12px; line-height:1.5;">
          ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸° ìƒíƒœë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.<br>
          <strong style="color:var(--danger);">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</strong> ë°˜ë“œì‹œ ë°±ì—… í›„ ì‹¤í–‰í•˜ì„¸ìš”.
        </div>
        <button class="btn btn-danger btn-sm" onclick="resetAllData()" style="width:100%;">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- ì‚¬ìš© ì•ˆë‚´ -->
  <div class="card">
    <h2>ğŸ“– ì‚¬ìš© ì•ˆë‚´</h2>

    <!-- ì‹œì‘í•˜ê¸° -->
    <div style="background:var(--primary-light); border-radius:10px; padding:16px; margin-bottom:16px; border-left:4px solid var(--primary);">
      <div style="font-weight:700; font-size:0.95rem; margin-bottom:8px;">ğŸš€ ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?</div>
      <div style="font-size:0.83rem; line-height:1.7; color:var(--text2);">
        <strong style="color:var(--text);">1ë‹¨ê³„:</strong> ì´ <strong>ì„¤ì • íƒ­</strong>ì—ì„œ ë³¸ì¸/ë°°ìš°ì í”„ë¡œí•„ê³¼ ì€í‡´ ì˜ˆì • ì—°ë„ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.<br>
        <strong style="color:var(--text);">2ë‹¨ê³„:</strong> <strong>ì›” í˜„ê¸ˆ íë¦„</strong> íƒ­ì—ì„œ ì—°ê¸ˆ, íˆ¬ììˆ˜ì…, ì§€ì¶œì„ ì…ë ¥í•˜ë©´ ë‚˜ì´ë³„ í˜„ê¸ˆíë¦„ì´ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.<br>
        <strong style="color:var(--text);">3ë‹¨ê³„:</strong> <strong>ìì‚° í¬íŠ¸í´ë¦¬ì˜¤</strong> íƒ­ì—ì„œ ë³´ìœ  ìì‚°ì„ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.<br>
        <strong style="color:var(--text);">4ë‹¨ê³„:</strong> <strong>ê³„ì¢Œë³„ í¬íŠ¸í´ë¦¬ì˜¤</strong> íƒ­ì—ì„œ íˆ¬ì ê³„ì¢Œì™€ ë³´ìœ  ì¢…ëª©ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- íƒ­ë³„ ê¸°ëŠ¥ ì•ˆë‚´ -->
    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; margin-bottom:16px;">

      <div style="border:1px solid var(--border); border-radius:10px; padding:14px;">
        <div style="font-weight:700; font-size:0.92rem; margin-bottom:8px;">ğŸ’° ì›” í˜„ê¸ˆ íë¦„</div>
        <ul style="font-size:0.8rem; color:var(--text2); line-height:1.7; margin:0; padding-left:18px;">
          <li><strong>ìˆ˜ì…ì› ê´€ë¦¬</strong> â€” ì—°ê¸ˆ(êµ­ë¯¼ì—°ê¸ˆ, í‡´ì§ì—°ê¸ˆ ë“±), íˆ¬ììˆ˜ì…, ê¸°íƒ€ìˆ˜ì…ì„ ë“±ë¡</li>
          <li><strong>ì§€ì¶œ ê´€ë¦¬</strong> â€” ìƒí™œë¹„, ë³´í—˜, ì—¬ê°€ ë“± ê³ ì •/ë³€ë™ ì§€ì¶œ ì…ë ¥</li>
          <li><strong>ë‚˜ì´ë³„ í˜„ê¸ˆíë¦„</strong> â€” ìˆ˜ì…ê³¼ ì§€ì¶œì˜ ì°¨ì´ë¥¼ ì—°ë ¹ëŒ€ë³„ë¡œ ìë™ ì‹œë®¬ë ˆì´ì…˜</li>
          <li><strong>ë¬¼ê°€ìƒìŠ¹ë¥  ë°˜ì˜</strong> â€” ì„¤ì •í•œ ë¬¼ê°€ìƒìŠ¹ë¥ ì— ë”°ë¼ ë¯¸ë˜ ê¸ˆì•¡ ìë™ ë³´ì •</li>
        </ul>
      </div>

      <div style="border:1px solid var(--border); border-radius:10px; padding:14px;">
        <div style="font-weight:700; font-size:0.92rem; margin-bottom:8px;">ğŸ“Š ìì‚° í¬íŠ¸í´ë¦¬ì˜¤</div>
        <ul style="font-size:0.8rem; color:var(--text2); line-height:1.7; margin:0; padding-left:18px;">
          <li><strong>ìì‚° ë“±ë¡</strong> â€” ë¶€ë™ì‚°, ê¸ˆìœµìì‚°, ì—°ê¸ˆ, ê¸°íƒ€ìì‚° ë“±ì„ ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì…ë ¥</li>
          <li><strong>ìì‚° ë¹„ìœ¨ ì°¨íŠ¸</strong> â€” ì „ì²´ ìì‚° ë°°ë¶„ì„ ë„ë„› ì°¨íŠ¸ë¡œ ì‹œê°í™”</li>
          <li><strong>ëª©í‘œ ìì‚° ì„¤ì •</strong> â€” ì€í‡´ ìê¸ˆ ëª©í‘œ ëŒ€ë¹„ í˜„ì¬ ë‹¬ì„±ë¥  í™•ì¸</li>
        </ul>
      </div>

      <div style="border:1px solid var(--border); border-radius:10px; padding:14px;">
        <div style="font-weight:700; font-size:0.92rem; margin-bottom:8px;">ğŸ“‹ ê³„ì¢Œë³„ í¬íŠ¸í´ë¦¬ì˜¤</div>
        <ul style="font-size:0.8rem; color:var(--text2); line-height:1.7; margin:0; padding-left:18px;">
          <li><strong>ê³„ì¢Œ ê´€ë¦¬</strong> â€” ì—°ê¸ˆì €ì¶•, IRP, í•´ì™¸ì£¼ì‹ ë“± íˆ¬ì ê³„ì¢Œ ë“±ë¡</li>
          <li><strong>ì¢…ëª© ê´€ë¦¬</strong> â€” ë³´ìœ  ì¢…ëª©ì˜ ë§¤ìˆ˜ë‹¨ê°€, ìˆ˜ëŸ‰, ë°°ë‹¹ë¥  ì…ë ¥</li>
          <li><strong>í˜„ì¬ê°€ ê°±ì‹ </strong> â€” ì¢…ëª©ì½”ë“œ ì…ë ¥ ì‹œ ì‹¤ì‹œê°„ í˜„ì¬ê°€ë¥¼ ìë™ ì¡°íšŒ
            <br><span style="color:var(--primary);font-size:0.75rem;">í•œêµ­ì£¼ì‹: ì¢…ëª©ì½”ë“œ(360750) / ë¯¸êµ­ì£¼ì‹: í‹°ì»¤(TSLA) / ì•”í˜¸í™”í: C:í‹°ì»¤(C:BTC)</span></li>
          <li><strong>ìˆ˜ìµë¥ Â·ë°°ë‹¹ ì°¨íŠ¸</strong> â€” ì¢…ëª©ë³„ ìˆ˜ìµë¥ , ë¶„ê¸°ë³„Â·ì›”ë³„ ë°°ë‹¹ê¸ˆ ì‹œê°í™”</li>
        </ul>
      </div>

      <div style="border:1px solid var(--border); border-radius:10px; padding:14px;">
        <div style="font-weight:700; font-size:0.92rem; margin-bottom:8px;">âš™ï¸ ì„¤ì •</div>
        <ul style="font-size:0.8rem; color:var(--text2); line-height:1.7; margin:0; padding-left:18px;">
          <li><strong>í”„ë¡œí•„</strong> â€” ë³¸ì¸/ë°°ìš°ì ì´ë¦„, ì¶œìƒì—°ë„ ì„¤ì •</li>
          <li><strong>ê¸°ë³¸ ì„¤ì •</strong> â€” ì€í‡´ì—°ë„, ë¬¼ê°€ìƒìŠ¹ë¥ , ë°°ë‹¹ì„±ì¥ë¥ , ì„¸ìœ¨ ì¡°ì •</li>
          <li><strong>ë°ì´í„° ê´€ë¦¬</strong> â€” JSON ë°±ì—…/ë³µì›, ì „ì²´ ì´ˆê¸°í™”</li>
          <li><strong>ë‹¤í¬ëª¨ë“œ</strong> â€” ìš°ì¸¡ ìƒë‹¨ ğŸŒ™/â˜€ï¸ ë²„íŠ¼ìœ¼ë¡œ ì „í™˜</li>
        </ul>
      </div>
    </div>

    <!-- ì•Œì•„ë‘ë©´ ì¢‹ì€ íŒ -->
    <div style="background:rgba(16,185,129,0.06); border-radius:10px; padding:14px; border-left:4px solid var(--accent);">
      <div style="font-weight:700; font-size:0.92rem; margin-bottom:8px;">ğŸ’¡ ì•Œì•„ë‘ë©´ ì¢‹ì€ íŒ</div>
      <ul style="font-size:0.8rem; color:var(--text2); line-height:1.8; margin:0; padding-left:18px;">
        <li>ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë˜ë¯€ë¡œ ë³„ë„ ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.</li>
        <li>ë‹¨, <strong>ë¸Œë¼ìš°ì € ìºì‹œë¥¼ ì‚­ì œí•˜ë©´ ë°ì´í„°ê°€ ì‚¬ë¼ì§€ë¯€ë¡œ</strong> ì •ê¸°ì ìœ¼ë¡œ JSON ë°±ì—…ì„ í•´ë‘ì„¸ìš”.</li>
        <li>ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´, JSON íŒŒì¼ì„ ë‚´ë³´ë‚´ê¸° í›„ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ê°€ì ¸ì˜¤ê¸° í•˜ë©´ ë©ë‹ˆë‹¤.</li>
        <li>í˜„ì¬ê°€ ê°±ì‹ ì€ <strong>ì¢…ëª©ì½”ë“œê°€ ì…ë ¥ëœ ì¢…ëª©ë§Œ</strong> ìë™ ì¡°íšŒë©ë‹ˆë‹¤ (ì¢…ëª© ìˆ˜ì •ì—ì„œ ì½”ë“œ ì…ë ¥).</li>
      </ul>
    </div>
  </div>
  <div class="app-footer" id="footer-tab4"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-content" onclick="event.stopPropagation()"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ========== ì „ì—­ ìƒíƒœ ==========
let appData = {
  settings: {
    birth: '1970-04',
    inflationRate: 2.0,
    dividendGrowthRate: 2.5,
    pensionTaxRate: 3.3,
    dividendTaxRate: 15.4,
    retireYear: 2029,
    owner: { name: '', nickname: '', gender: 'male', birthYear: 1970 },
    spouse: { name: '', nickname: '', gender: 'female', birthYear: 1972 }
  },
  incomes: [],
  expenses: [],
  assets: [],
  accounts: [],
  currentAccountIdx: -1
};

let charts = {};

// ========== ìœ í‹¸ë¦¬í‹° ==========
function formatNum(n) {
  if (n === undefined || n === null || isNaN(n)) return '0';
  if (Number.isInteger(n) || Math.abs(n) >= 100) return Math.round(n).toLocaleString('ko-KR');
  return n.toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 1 });
}
function formatManWon(n) {
  if (n === undefined || n === null || isNaN(n)) return '0ë§Œì›';
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 10000) {
    const eok = Math.floor(abs / 10000);
    const man = Math.round(abs % 10000);
    if (man === 0) return `${sign}${eok.toLocaleString('ko-KR')}ì–µì›`;
    return `${sign}${eok.toLocaleString('ko-KR')}ì–µ ${man.toLocaleString('ko-KR')}ë§Œì›`;
  }
  return `${sign}${formatNum(abs)}ë§Œì›`;
}
function formatPercent(n) {
  if (isNaN(n) || !isFinite(n)) return '0.0%';
  return (n >= 0 ? '+' : '') + n.toFixed(1) + '%';
}
function getBirthYear() {
  return parseInt(appData.settings.birth.split('-')[0]);
}
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function saveData() {
  localStorage.setItem('retireApp', JSON.stringify(appData));
}
function loadData() {
  const d = localStorage.getItem('retireApp');
  if (d) {
    try {
      const parsed = JSON.parse(d);
      appData = { ...appData, ...parsed };
      appData.settings = { ...appData.settings, ...(parsed.settings || {}) };
    } catch(e) { console.error(e); }
  }
}

// ========== í…Œë§ˆ ==========
function toggleTheme() {
  document.body.classList.toggle('dark');
  const btn = document.querySelector('.theme-toggle');
  btn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  Object.values(charts).forEach(c => { if(c) c.update(); });
}

// ========== íƒ­ ì „í™˜ ==========
function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  const btns = document.querySelectorAll('.tab-nav button');
  const idx = ['cashflow','portfolio','accounts','settings'].indexOf(name);
  if (idx >= 0) btns[idx].classList.add('active');

  if (name === 'cashflow') calculateCashflow();
  if (name === 'portfolio') renderAssets();
  if (name === 'accounts') renderAccounts();
}

// ========== ëª¨ë‹¬ ==========
function openModal(html) {
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('modal-overlay').classList.add('show');
}
function closeModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('show');
}
function closeModalForce() {
  document.getElementById('modal-overlay').classList.remove('show');
}

// ===================================================================
//  íƒ­ 1: ì›” í˜„ê¸ˆ íë¦„
// ===================================================================

function addIncome(type) {
  const typeLabels = { pension: 'ì—°ê¸ˆ', investment: 'íˆ¬ììˆ˜ì…', other: 'ê¸°íƒ€ìˆ˜ì…' };
  const typeLabel = typeLabels[type] || 'ìˆ˜ì…';

  let extraFields = '';
  if (type === 'pension') {
    extraFields = `
      <div class="form-group">
        <label>ì†Œìœ ì</label>
        <select id="mi-owner"><option value="ë³¸ì¸">ë³¸ì¸</option><option value="ë°°ìš°ì">ë°°ìš°ì</option></select>
      </div>
      <div class="form-group">
        <label>ì—°ê¸ˆê¸°ê´€</label>
        <input type="text" id="mi-provider" placeholder="ì˜ˆ: ì‚¬í•™ì—°ê¸ˆ, ë¯¸ë˜ì—ì…‹ì¦ê¶Œ">
      </div>
      <div class="form-group">
        <label>ìƒí’ˆëª…</label>
        <input type="text" id="mi-product" placeholder="ì˜ˆ: í‡´ì§ì—°ê¸ˆ">
      </div>
      <div class="form-group">
        <label>ìˆ˜ë ¹ì‹œì‘ ì—°ë„</label>
        <input type="number" id="mi-start" value="2030" min="2024" max="2060">
      </div>
      <div class="form-group">
        <label>ìˆ˜ë ¹ì¢…ë£Œ ì—°ë„</label>
        <input type="number" id="mi-end" value="2050" min="2024" max="2070">
      </div>
      <div class="form-group">
        <label>ì›” ìˆ˜ë ¹ì•¡ (ë§Œì›)</label>
        <input type="number" id="mi-amount" value="0" step="0.1">
      </div>
      <div class="form-group">
        <label>ì—°ê°„ ì¸ìƒë¥  (%)</label>
        <input type="number" id="mi-growth" value="1.0" step="0.1">
      </div>
    `;
  } else if (type === 'investment') {
    extraFields = `
      <div class="form-group">
        <label>ì†Œìœ ì</label>
        <select id="mi-owner"><option value="ë³¸ì¸">ë³¸ì¸</option><option value="ë°°ìš°ì">ë°°ìš°ì</option></select>
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œ/ì¶œì²˜</label>
        <input type="text" id="mi-provider" placeholder="ì˜ˆ: ISA, ë°°ë‹¹ê³„ì¢Œ">
      </div>
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <input type="text" id="mi-product" placeholder="ì˜ˆ: ì›”ë°°ë‹¹ ETF ìˆ˜ìµ">
      </div>
      <div class="form-group">
        <label>ìˆ˜ë ¹ì‹œì‘ ì—°ë„</label>
        <input type="number" id="mi-start" value="2026" min="2024" max="2060">
      </div>
      <div class="form-group">
        <label>ìˆ˜ë ¹ì¢…ë£Œ ì—°ë„</label>
        <input type="number" id="mi-end" value="2055" min="2024" max="2070">
      </div>
      <div class="form-group">
        <label>ì›” ìˆ˜ë ¹ì•¡ (ë§Œì›)</label>
        <input type="number" id="mi-amount" value="0" step="0.1">
      </div>
      <div class="form-group">
        <label>ì—°ê°„ ì„±ì¥ë¥  (%)</label>
        <input type="number" id="mi-growth" value="2.5" step="0.1">
      </div>
    `;
  } else {
    extraFields = `
      <div class="form-group">
        <label>ì„¤ëª…</label>
        <input type="text" id="mi-product" placeholder="ì˜ˆ: ì„ëŒ€ìˆ˜ì…">
      </div>
      <div class="form-group">
        <label>ì‹œì‘ ì—°ë„</label>
        <input type="number" id="mi-start" value="2026" min="2024" max="2060">
      </div>
      <div class="form-group">
        <label>ì¢…ë£Œ ì—°ë„</label>
        <input type="number" id="mi-end" value="2055" min="2024" max="2070">
      </div>
      <div class="form-group">
        <label>ì›” ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="mi-amount" value="0" step="0.1">
      </div>
      <div class="form-group">
        <label>ì—°ê°„ ì„±ì¥ë¥  (%)</label>
        <input type="number" id="mi-growth" value="0" step="0.1">
      </div>
    `;
  }

  openModal(`
    <h3>${typeLabel} ì¶”ê°€</h3>
    <div class="form-grid">${extraFields}</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveIncome('${type}', -1)">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function editIncome(idx) {
  const inc = appData.incomes[idx];
  const type = inc.type;
  const typeLabels = { pension: 'ì—°ê¸ˆ', investment: 'íˆ¬ììˆ˜ì…', other: 'ê¸°íƒ€ìˆ˜ì…' };
  const typeLabel = typeLabels[type] || 'ìˆ˜ì…';
  const ownerSelect = `<div class="form-group"><label>ì†Œìœ ì</label><select id="mi-owner"><option value="ë³¸ì¸" ${inc.owner === 'ë³¸ì¸' ? 'selected' : ''}>ë³¸ì¸</option><option value="ë°°ìš°ì" ${inc.owner === 'ë°°ìš°ì' ? 'selected' : ''}>ë°°ìš°ì</option></select></div>`;

  let extraFields = '';
  if (type === 'pension') {
    extraFields = `
      ${ownerSelect}
      <div class="form-group"><label>ì—°ê¸ˆê¸°ê´€</label><input type="text" id="mi-provider" value="${inc.provider || ''}"></div>
      <div class="form-group"><label>ìƒí’ˆëª…</label><input type="text" id="mi-product" value="${inc.product || ''}"></div>
      <div class="form-group"><label>ìˆ˜ë ¹ì‹œì‘ ì—°ë„</label><input type="number" id="mi-start" value="${inc.startYear}" min="2024" max="2060"></div>
      <div class="form-group"><label>ìˆ˜ë ¹ì¢…ë£Œ ì—°ë„</label><input type="number" id="mi-end" value="${inc.endYear}" min="2024" max="2070"></div>
      <div class="form-group"><label>ì›” ìˆ˜ë ¹ì•¡ (ë§Œì›)</label><input type="number" id="mi-amount" value="${inc.monthlyAmount}" step="0.1"></div>
      <div class="form-group"><label>ì—°ê°„ ì¸ìƒë¥  (%)</label><input type="number" id="mi-growth" value="${inc.growthRate}" step="0.1"></div>`;
  } else if (type === 'investment') {
    extraFields = `
      ${ownerSelect}
      <div class="form-group"><label>ê³„ì¢Œ/ì¶œì²˜</label><input type="text" id="mi-provider" value="${inc.provider || ''}"></div>
      <div class="form-group"><label>ì„¤ëª…</label><input type="text" id="mi-product" value="${inc.product || ''}"></div>
      <div class="form-group"><label>ìˆ˜ë ¹ì‹œì‘ ì—°ë„</label><input type="number" id="mi-start" value="${inc.startYear}" min="2024" max="2060"></div>
      <div class="form-group"><label>ìˆ˜ë ¹ì¢…ë£Œ ì—°ë„</label><input type="number" id="mi-end" value="${inc.endYear}" min="2024" max="2070"></div>
      <div class="form-group"><label>ì›” ìˆ˜ë ¹ì•¡ (ë§Œì›)</label><input type="number" id="mi-amount" value="${inc.monthlyAmount}" step="0.1"></div>
      <div class="form-group"><label>ì—°ê°„ ì„±ì¥ë¥  (%)</label><input type="number" id="mi-growth" value="${inc.growthRate}" step="0.1"></div>`;
  } else {
    extraFields = `
      <div class="form-group"><label>ì„¤ëª…</label><input type="text" id="mi-product" value="${inc.product || ''}"></div>
      <div class="form-group"><label>ì‹œì‘ ì—°ë„</label><input type="number" id="mi-start" value="${inc.startYear}" min="2024" max="2060"></div>
      <div class="form-group"><label>ì¢…ë£Œ ì—°ë„</label><input type="number" id="mi-end" value="${inc.endYear}" min="2024" max="2070"></div>
      <div class="form-group"><label>ì›” ê¸ˆì•¡ (ë§Œì›)</label><input type="number" id="mi-amount" value="${inc.monthlyAmount}" step="0.1"></div>
      <div class="form-group"><label>ì—°ê°„ ì„±ì¥ë¥  (%)</label><input type="number" id="mi-growth" value="${inc.growthRate}" step="0.1"></div>`;
  }

  openModal(`
    <h3>${typeLabel} ìˆ˜ì •</h3>
    <div class="form-grid">${extraFields}</div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveIncome('${type}', ${idx})">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveIncome(type, idx) {
  const income = {
    type,
    owner: document.getElementById('mi-owner')?.value || 'ë³¸ì¸',
    provider: document.getElementById('mi-provider')?.value || '',
    product: document.getElementById('mi-product')?.value || '',
    startYear: parseInt(document.getElementById('mi-start').value),
    endYear: parseInt(document.getElementById('mi-end').value),
    monthlyAmount: parseFloat(document.getElementById('mi-amount').value) || 0,
    growthRate: parseFloat(document.getElementById('mi-growth').value) || 0
  };
  if (idx !== undefined && idx >= 0) {
    appData.incomes[idx] = income;
  } else {
    appData.incomes.push(income);
  }
  saveData();
  renderIncomes();
  closeModalForce();
  showToast(idx >= 0 ? 'ìˆ˜ì…ì›ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìˆ˜ì…ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderIncomes() {
  const container = document.getElementById('income-list');
  if (appData.incomes.length === 0) {
    container.innerHTML = '<p style="color:var(--text2); font-size:0.9rem; padding:12px;">ë“±ë¡ëœ ìˆ˜ì…ì›ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•˜ì„¸ìš”.</p>';
    return;
  }
  const typeColors = { pension: '#3b82f6', investment: '#10b981', other: '#f59e0b' };
  const typeLabels = { pension: 'ì—°ê¸ˆ', investment: 'íˆ¬ììˆ˜ì…', other: 'ê¸°íƒ€' };
  container.innerHTML = appData.incomes.map((inc, i) => `
    <div class="income-item editable" onclick="editIncome(${i})" style="border-left: 4px solid ${typeColors[inc.type] || '#999'}">
      <button class="delete-btn" onclick="event.stopPropagation(); deleteIncome(${i})" title="ì‚­ì œ">&times;</button>
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
        <span style="background:${typeColors[inc.type]};color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;">${typeLabels[inc.type]}</span>
        <strong>${inc.owner || ''} ${inc.provider || ''} ${inc.product || ''}</strong>
        <span style="color:var(--text2);font-size:0.85rem;">${inc.startYear}~${inc.endYear}ë…„</span>
        <span style="font-weight:600;">ì›” ${formatNum(inc.monthlyAmount)}ë§Œì›</span>
        <span style="color:var(--text2);font-size:0.82rem;">ì—° ${inc.growthRate}% ì¸ìƒ</span>
      </div>
    </div>
  `).join('');
}

function deleteIncome(idx) {
  appData.incomes.splice(idx, 1);
  saveData();
  renderIncomes();
  showToast('ìˆ˜ì…ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ì§€ì¶œ
function addExpense() {
  openModal(`
    <h3>ì§€ì¶œí•­ëª© ì¶”ê°€</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>í•­ëª©ëª…</label>
        <input type="text" id="me-name" placeholder="ì˜ˆ: ìƒí™œë¹„">
      </div>
      <div class="form-group">
        <label>êµ¬ë¶„</label>
        <select id="me-type"><option value="fixed">ê³ ì •ì§€ì¶œ</option><option value="variable">ë³€ë™ì§€ì¶œ</option></select>
      </div>
      <div class="form-group">
        <label>ì›” ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="me-amount" value="0" step="0.1">
      </div>
      <div class="form-group">
        <label>ì‹œì‘ ì—°ë„</label>
        <input type="number" id="me-start" value="2026" min="2024" max="2060">
      </div>
      <div class="form-group">
        <label>ì¢…ë£Œ ì—°ë„</label>
        <input type="number" id="me-end" value="2060" min="2024" max="2070">
      </div>
      <div class="form-group">
        <label>ì—°ê°„ ì¸ìƒë¥  (%)</label>
        <input type="number" id="me-growth" value="2.0" step="0.1">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveExpense(-1)">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function editExpense(idx) {
  const exp = appData.expenses[idx];
  openModal(`
    <h3>ì§€ì¶œí•­ëª© ìˆ˜ì •</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>í•­ëª©ëª…</label>
        <input type="text" id="me-name" value="${exp.name}">
      </div>
      <div class="form-group">
        <label>êµ¬ë¶„</label>
        <select id="me-type"><option value="fixed" ${exp.type === 'fixed' ? 'selected' : ''}>ê³ ì •ì§€ì¶œ</option><option value="variable" ${exp.type === 'variable' ? 'selected' : ''}>ë³€ë™ì§€ì¶œ</option></select>
      </div>
      <div class="form-group">
        <label>ì›” ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="me-amount" value="${exp.monthlyAmount}" step="0.1">
      </div>
      <div class="form-group">
        <label>ì‹œì‘ ì—°ë„</label>
        <input type="number" id="me-start" value="${exp.startYear}" min="2024" max="2060">
      </div>
      <div class="form-group">
        <label>ì¢…ë£Œ ì—°ë„</label>
        <input type="number" id="me-end" value="${exp.endYear}" min="2024" max="2070">
      </div>
      <div class="form-group">
        <label>ì—°ê°„ ì¸ìƒë¥  (%)</label>
        <input type="number" id="me-growth" value="${exp.growthRate}" step="0.1">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveExpense(${idx})">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveExpense(idx) {
  const expense = {
    name: document.getElementById('me-name').value || 'ì§€ì¶œ',
    type: document.getElementById('me-type').value,
    monthlyAmount: parseFloat(document.getElementById('me-amount').value) || 0,
    startYear: parseInt(document.getElementById('me-start').value),
    endYear: parseInt(document.getElementById('me-end').value),
    growthRate: parseFloat(document.getElementById('me-growth').value) || 0
  };
  if (idx !== undefined && idx >= 0) {
    appData.expenses[idx] = expense;
  } else {
    appData.expenses.push(expense);
  }
  saveData();
  renderExpenses();
  closeModalForce();
  showToast(idx >= 0 ? 'ì§€ì¶œí•­ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì§€ì¶œí•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderExpenses() {
  const container = document.getElementById('expense-list');
  if (appData.expenses.length === 0) {
    container.innerHTML = '<p style="color:var(--text2); font-size:0.9rem; padding:12px;">ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  container.innerHTML = appData.expenses.map((exp, i) => `
    <div class="income-item editable" onclick="editExpense(${i})" style="border-left: 4px solid ${exp.type === 'fixed' ? '#ef4444' : '#f59e0b'}">
      <button class="delete-btn" onclick="event.stopPropagation(); deleteExpense(${i})" title="ì‚­ì œ">&times;</button>
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
        <span style="background:${exp.type === 'fixed' ? '#ef4444' : '#f59e0b'};color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;">${exp.type === 'fixed' ? 'ê³ ì •' : 'ë³€ë™'}</span>
        <strong>${exp.name}</strong>
        <span style="color:var(--text2);font-size:0.85rem;">${exp.startYear}~${exp.endYear}ë…„</span>
        <span style="font-weight:600;">ì›” ${formatNum(exp.monthlyAmount)}ë§Œì›</span>
      </div>
    </div>
  `).join('');
}

function deleteExpense(idx) {
  appData.expenses.splice(idx, 1);
  saveData();
  renderExpenses();
  showToast('ì§€ì¶œí•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderProfileBanner() {
  const o = appData.settings.owner || {};
  const s = appData.settings.spouse || {};
  const thisYear = new Date().getFullYear();
  const oAge = o.birthYear ? thisYear - o.birthYear : '';
  const sAge = s.birthYear ? thisYear - s.birthYear : '';
  const oIcon = o.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
  const sIcon = s.gender === 'female' ? 'ğŸ‘©' : 'ğŸ‘¨';
  const oGenderLabel = o.gender === 'female' ? 'ì—¬' : 'ë‚¨';
  const sGenderLabel = s.gender === 'female' ? 'ì—¬' : 'ë‚¨';
  const oColor = o.gender === 'female' ? '#ec4899' : '#3b82f6';
  const sColor = s.gender === 'female' ? '#ec4899' : '#3b82f6';

  const oDisplay = o.nickname || o.name || 'ë³¸ì¸';
  const sDisplay = s.nickname || s.name || 'ë°°ìš°ì';

  document.getElementById('profile-banner').innerHTML = `
    <div class="profile-card">
      <div class="profile-avatar" style="background:${oColor}20;color:${oColor};">${oIcon}</div>
      <div class="profile-info">
        <div class="p-nickname">${oDisplay}</div>
        ${o.name && o.nickname ? `<div class="p-name">${o.name}</div>` : ''}
        <div class="p-detail">
          <span>${oGenderLabel}</span>
          ${oAge ? `<span>${oAge}ì„¸ (${o.birthYear}ë…„ìƒ)</span>` : ''}
        </div>
      </div>
    </div>
    <div class="profile-card">
      <div class="profile-avatar" style="background:${sColor}20;color:${sColor};">${sIcon}</div>
      <div class="profile-info">
        <div class="p-nickname">${sDisplay}</div>
        ${s.name && s.nickname ? `<div class="p-name">${s.name}</div>` : ''}
        <div class="p-detail">
          <span>${sGenderLabel}</span>
          ${sAge ? `<span>${sAge}ì„¸ (${s.birthYear}ë…„ìƒ)</span>` : ''}
        </div>
      </div>
    </div>
  `;
}

// í˜„ê¸ˆ íë¦„ ê³„ì‚°
function calculateCashflow() {
  renderProfileBanner();
  const birthYear = getBirthYear();
  const retireYear = appData.settings.retireYear || 2029;
  const startAge = retireYear - birthYear;
  const endAge = 90;
  const ages = [];
  for (let a = startAge; a <= endAge; a++) ages.push(a);

  // ì„¸ìœ¨ ì„¤ì •
  const pensionTaxRate = (appData.settings.pensionTaxRate || 3.3) / 100;
  const dividendTaxRate = (appData.settings.dividendTaxRate || 15.4) / 100;

  // ìˆ˜ì…ì›ë³„ë¡œ ê° ì—°ë ¹ì˜ ì›” ê¸ˆì•¡ ê³„ì‚° (ì„¸í›„)
  const incomeLabels = appData.incomes.map(inc =>
    `${inc.owner || ''} ${inc.provider || ''} ${inc.product || ''}`.trim() || 'ìˆ˜ì…'
  );
  const incomeDatasets = appData.incomes.map(inc => {
    // ìˆ˜ì… ìœ í˜•ë³„ ì„¸ìœ¨ ì ìš©: ì—°ê¸ˆ â†’ ì—°ê¸ˆì†Œë“ì„¸, íˆ¬ììˆ˜ì… â†’ ë°°ë‹¹ì†Œë“ì„¸, ê¸°íƒ€ â†’ ì„¸ê¸ˆ ì—†ìŒ
    const taxRate = inc.type === 'pension' ? pensionTaxRate :
                    inc.type === 'investment' ? dividendTaxRate : 0;
    return ages.map(age => {
      const year = birthYear + age;
      if (year < inc.startYear || year > inc.endYear) return 0;
      const yearsFromStart = year - inc.startYear;
      const gross = inc.monthlyAmount * Math.pow(1 + inc.growthRate / 100, yearsFromStart);
      return gross * (1 - taxRate);
    });
  });

  // ì§€ì¶œ
  const totalExpenseByAge = ages.map(age => {
    const year = birthYear + age;
    return appData.expenses.reduce((sum, exp) => {
      if (year < exp.startYear || year > exp.endYear) return sum;
      const yearsFromStart = year - exp.startYear;
      return sum + exp.monthlyAmount * Math.pow(1 + exp.growthRate / 100, yearsFromStart);
    }, 0);
  });

  const totalIncomeByAge = ages.map((_, i) =>
    incomeDatasets.reduce((sum, ds) => sum + ds[i], 0)
  );
  const netByAge = ages.map((_, i) => totalIncomeByAge[i] - totalExpenseByAge[i]);

  // ìš”ì•½ ì¹´ë“œ
  const currentAge = new Date().getFullYear() - birthYear;
  const closestIdx = ages.indexOf(currentAge >= startAge ? currentAge : startAge);

  // ì€í‡´ ì‹œì‘ ë‚˜ì´ + 60ì„¸ë¶€í„° 5ë…„ ë‹¨ìœ„ë¡œ 80ì„¸ê¹Œì§€
  const agePoints = [
    { age: startAge, label: `${startAge}ì„¸ (ì€í‡´)`, idx: ages.indexOf(startAge) }
  ];
  for (let a = 60; a <= 80; a += 5) {
    if (a > startAge) {
      const idx = ages.indexOf(a);
      if (idx >= 0) agePoints.push({ age: a, label: `${a}ì„¸`, idx });
    }
  }

  // ì¹´ë“œë³„ ìƒ‰ìƒ ë°°ì—´ (ì–‘ìˆ˜/ìŒìˆ˜ ê°ê° ë‹¤ë¥¸ ìƒ‰ìƒ)
  const cardColorsPositive = ['teal', 'sky', 'emerald', 'purple', 'indigo', 'green', 'amber'];
  const cardColorsNegative = ['red', 'rose', 'orange', 'red', 'rose', 'orange', 'red'];

  let summaryHTML = '<h3 style="grid-column:1/-1;margin:0 0 4px;font-size:1.05rem;color:var(--accent);">ğŸ“Œ ë‚˜ì´ëŒ€ë³„ ì›” í˜„ê¸ˆíë¦„</h3>';
  agePoints.forEach((p, cardIdx) => {
    const net = netByAge[p.idx];
    const colorClass = net >= 0 ? cardColorsPositive[cardIdx % cardColorsPositive.length] : cardColorsNegative[cardIdx % cardColorsNegative.length];
    summaryHTML += `
      <div class="summary-card ${colorClass}">
        <div class="label">${p.label} ì›” í˜„ê¸ˆíë¦„</div>
        <div class="value">${formatNum(net)}ë§Œì›</div>
        <div class="sub-label" style="font-size:0.78rem;color:var(--text-secondary);margin-top:2px;">ìˆ˜ì… ${formatNum(totalIncomeByAge[p.idx])} / ì§€ì¶œ ${formatNum(totalExpenseByAge[p.idx])}</div>
      </div>
    `;
  });
  document.getElementById('cashflow-summary').innerHTML = summaryHTML;

  // ìŠ¤íƒë°” ì°¨íŠ¸
  const colors = [
    '#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6',
    '#ec4899','#06b6d4','#84cc16','#f97316','#6366f1',
    '#14b8a6','#e11d48','#0ea5e9','#a855f7'
  ];

  const datasets = incomeDatasets.map((ds, i) => ({
    label: incomeLabels[i],
    data: ds.map(v => Math.round(v)),
    backgroundColor: colors[i % colors.length],
    stack: 'income'
  }));
  datasets.push({
    label: 'ì§€ì¶œ',
    data: totalExpenseByAge.map(v => -Math.round(v)),
    backgroundColor: '#ef4444',
    stack: 'expense'
  });

  if (charts.cashflow) charts.cashflow.destroy();
  charts.cashflow = new Chart(document.getElementById('cashflow-chart'), {
    type: 'bar',
    data: {
      labels: ages.map(a => a + 'ì„¸'),
      datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 11 }, boxWidth: 12 } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${formatNum(Math.abs(ctx.raw))}ë§Œì›`
          }
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          ticks: { callback: v => formatNum(v) + 'ë§Œì›' }
        }
      }
    }
  });

  // ìˆœí˜„ê¸ˆíë¦„ ë¼ì¸ ì°¨íŠ¸
  if (charts.netcashflow) charts.netcashflow.destroy();
  charts.netcashflow = new Chart(document.getElementById('netcashflow-chart'), {
    type: 'line',
    data: {
      labels: ages.map(a => a + 'ì„¸'),
      datasets: [
        {
          label: 'ì›” ìˆ˜ì…',
          data: totalIncomeByAge.map(v => Math.round(v)),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'ì›” ì§€ì¶œ',
          data: totalExpenseByAge.map(v => Math.round(v)),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239,68,68,0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'ì›” í˜„ê¸ˆíë¦„',
          data: netByAge.map(v => Math.round(v)),
          borderColor: '#10b981',
          borderWidth: 3,
          borderDash: [5, 5],
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatNum(ctx.raw)}ë§Œì›` } }
      },
      scales: {
        y: { ticks: { callback: v => formatNum(v) + 'ë§Œì›' } }
      }
    }
  });

  // í…Œì´ë¸”
  const tableWrap = document.getElementById('cashflow-table-wrap');
  let tableHTML = '<table><thead><tr><th>ì—°ë ¹</th><th>ì—°ë„</th>';
  appData.incomes.forEach(inc => {
    const line1 = inc.owner || '';
    const line2 = `${inc.provider || ''} ${inc.product || ''}`.trim() || 'ìˆ˜ì…';
    tableHTML += `<th style="white-space:nowrap;line-height:1.4;"><span style="font-size:0.7rem;color:var(--primary);display:block;">${line1}</span>${line2}</th>`;
  });
  tableHTML += '<th>ì›” ìˆ˜ì…</th><th>ì›” ì§€ì¶œ</th><th>ì›” í˜„ê¸ˆíë¦„</th></tr></thead><tbody>';
  ages.forEach((age, i) => {
    const year = birthYear + age;
    tableHTML += `<tr><td>${age}ì„¸</td><td>${year}</td>`;
    incomeDatasets.forEach(ds => {
      tableHTML += `<td>${formatNum(ds[i])}</td>`;
    });
    const net = netByAge[i];
    tableHTML += `<td style="font-weight:600;">${formatNum(totalIncomeByAge[i])}</td>`;
    tableHTML += `<td class="num-negative">${formatNum(totalExpenseByAge[i])}</td>`;
    tableHTML += `<td class="${net >= 0 ? 'num-positive' : 'num-negative'}">${formatNum(net)}</td>`;
    tableHTML += '</tr>';
  });
  tableHTML += '</tbody></table>';
  tableWrap.innerHTML = tableHTML;
}

// ===================================================================
//  íƒ­ 2: ìì‚° í¬íŠ¸í´ë¦¬ì˜¤
// ===================================================================

function addAsset() {
  openModal(`
    <h3>ìì‚° ì¶”ê°€</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="ma-cat">
          <option value="ì‚¬í•™ì—°ê¸ˆ">ì‚¬í•™ì—°ê¸ˆ (ì ë¦½ê¸ˆ)</option>
          <option value="ì—°ê¸ˆì €ì¶•/IRP">ì—°ê¸ˆì €ì¶•/IRP</option>
          <option value="ISA">ISA ê³„ì¢Œ</option>
          <option value="í•´ì™¸ì£¼ì‹">í•´ì™¸ì£¼ì‹</option>
          <option value="êµ­ë‚´ì£¼ì‹/ETF">êµ­ë‚´ì£¼ì‹/ETF</option>
          <option value="ì•”í˜¸í™”í">ì•”í˜¸í™”í (ë¹„íŠ¸ì½”ì¸ ë“±)</option>
          <option value="ë¶€ë™ì‚°">ë¶€ë™ì‚°</option>
          <option value="ì˜ˆì ê¸ˆ/í˜„ê¸ˆ">ì˜ˆì ê¸ˆ/í˜„ê¸ˆ</option>
          <option value="ë³´í—˜">ë³´í—˜</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>
      <div class="form-group">
        <label>ìì‚°ëª…</label>
        <input type="text" id="ma-name" placeholder="ì˜ˆ: ë¯¸ë˜ì—ì…‹ ì—°ê¸ˆì €ì¶•">
      </div>
      <div class="form-group">
        <label>ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="ma-amount" value="0" step="1">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveAsset(-1)">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function editAsset(idx) {
  const a = appData.assets[idx];
  const categories = [
    {v:'ì‚¬í•™ì—°ê¸ˆ',l:'ì‚¬í•™ì—°ê¸ˆ (ì ë¦½ê¸ˆ)'},{v:'ì—°ê¸ˆì €ì¶•/IRP',l:'ì—°ê¸ˆì €ì¶•/IRP'},{v:'ISA',l:'ISA ê³„ì¢Œ'},
    {v:'í•´ì™¸ì£¼ì‹',l:'í•´ì™¸ì£¼ì‹'},{v:'êµ­ë‚´ì£¼ì‹/ETF',l:'êµ­ë‚´ì£¼ì‹/ETF'},{v:'ì•”í˜¸í™”í',l:'ì•”í˜¸í™”í (ë¹„íŠ¸ì½”ì¸ ë“±)'},
    {v:'ë¶€ë™ì‚°',l:'ë¶€ë™ì‚°'},{v:'ì˜ˆì ê¸ˆ/í˜„ê¸ˆ',l:'ì˜ˆì ê¸ˆ/í˜„ê¸ˆ'},{v:'ë³´í—˜',l:'ë³´í—˜'},{v:'ê¸°íƒ€',l:'ê¸°íƒ€'}
  ];
  const catOptions = categories.map(c => `<option value="${c.v}" ${a.category === c.v ? 'selected' : ''}>${c.l}</option>`).join('');
  openModal(`
    <h3>ìì‚° ìˆ˜ì •</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="ma-cat">${catOptions}</select>
      </div>
      <div class="form-group">
        <label>ìì‚°ëª…</label>
        <input type="text" id="ma-name" value="${a.name}">
      </div>
      <div class="form-group">
        <label>ê¸ˆì•¡ (ë§Œì›)</label>
        <input type="number" id="ma-amount" value="${a.amount}" step="1">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveAsset(${idx})">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveAsset(idx) {
  const asset = {
    category: document.getElementById('ma-cat').value,
    name: document.getElementById('ma-name').value || 'ìì‚°',
    amount: parseFloat(document.getElementById('ma-amount').value) || 0
  };
  if (idx !== undefined && idx >= 0) {
    appData.assets[idx] = asset;
  } else {
    appData.assets.push(asset);
  }
  saveData();
  renderAssets();
  closeModalForce();
  showToast(idx >= 0 ? 'ìì‚°ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìì‚°ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderAssets() {
  const container = document.getElementById('asset-list');
  if (appData.assets.length === 0) {
    container.innerHTML = '<p style="color:var(--text2); font-size:0.9rem; padding:12px;">ë“±ë¡ëœ ìì‚°ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    updateAssetSummary(0);
    if (charts.assetPie) { charts.assetPie.destroy(); charts.assetPie = null; }
    document.getElementById('asset-breakdown').innerHTML = '';
    document.getElementById('asset-date-label').textContent = '';
    return;
  }

  const catColors = {
    'ì‚¬í•™ì—°ê¸ˆ': '#3b82f6', 'ì—°ê¸ˆì €ì¶•/IRP': '#10b981', 'ISA': '#f59e0b',
    'í•´ì™¸ì£¼ì‹': '#8b5cf6', 'êµ­ë‚´ì£¼ì‹/ETF': '#ec4899', 'ì•”í˜¸í™”í': '#f7931a',
    'ë¶€ë™ì‚°': '#06b6d4', 'ì˜ˆì ê¸ˆ/í˜„ê¸ˆ': '#84cc16', 'ë³´í—˜': '#f97316', 'ê¸°íƒ€': '#6366f1'
  };

  container.innerHTML = appData.assets.map((a, i) => `
    <div class="income-item editable" onclick="editAsset(${i})" style="border-left: 4px solid ${catColors[a.category] || '#999'}">
      <button class="delete-btn" onclick="event.stopPropagation(); deleteAsset(${i})" title="ì‚­ì œ">&times;</button>
      <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
        <span style="background:${catColors[a.category] || '#999'};color:white;padding:2px 8px;border-radius:4px;font-size:0.75rem;">${a.category}</span>
        <strong>${a.name}</strong>
        <span style="font-weight:600;">${formatManWon(a.amount)}</span>
      </div>
    </div>
  `).join('');

  const total = appData.assets.reduce((s, a) => s + a.amount, 0);
  updateAssetSummary(total);

  // ì¹´í…Œê³ ë¦¬ë³„ í•©ì‚°
  const catMap = {};
  appData.assets.forEach(a => {
    catMap[a.category] = (catMap[a.category] || 0) + a.amount;
  });
  const cats = Object.keys(catMap);
  const vals = cats.map(c => catMap[c]);
  const clrs = cats.map(c => catColors[c] || '#999');

  // ë„ë„› ì°¨íŠ¸ (í¼ì„¼íŠ¸ ì§ì ‘ í‘œì‹œ)
  if (charts.assetPie) charts.assetPie.destroy();
  const isDark = document.body.classList.contains('dark');
  charts.assetPie = new Chart(document.getElementById('asset-pie-chart'), {
    type: 'doughnut',
    data: {
      labels: cats,
      datasets: [{ data: vals, backgroundColor: clrs, borderWidth: 2, borderColor: isDark ? '#1e293b' : '#ffffff' }]
    },
    plugins: [{
      id: 'doughnutLabels',
      afterDraw(chart) {
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0);
        const ds = chart.data.datasets[0];
        const totalVal = ds.data.reduce((s, v) => s + v, 0);
        if (totalVal <= 0) return;
        // ì„¸ê·¸ë¨¼íŠ¸ ìœ„ í¼ì„¼íŠ¸
        meta.data.forEach((arc, i) => {
          const pct = (ds.data[i] / totalVal * 100);
          if (pct < 3) return;
          const { x, y } = arc.tooltipPosition();
          const centerX = chart.chartArea.left + chart.chartArea.width / 2;
          const centerY = chart.chartArea.top + chart.chartArea.height / 2;
          const midX = centerX + (x - centerX) * 1.0;
          const midY = centerY + (y - centerY) * 1.0;
          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.font = 'bold 12px sans-serif';
          ctx.fillStyle = '#ffffff';
          ctx.shadowColor = 'rgba(0,0,0,0.6)';
          ctx.shadowBlur = 3;
          ctx.fillText(pct.toFixed(1) + '%', midX, midY);
          ctx.restore();
        });
        // ë„ë„› ì¤‘ì•™ì— ì´ ìì‚° í‘œì‹œ
        const cX = chart.chartArea.left + chart.chartArea.width / 2;
        const cY = chart.chartArea.top + chart.chartArea.height / 2;
        const dk = document.body.classList.contains('dark');
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 11px sans-serif';
        ctx.fillStyle = dk ? '#94a3b8' : '#64748b';
        ctx.fillText('ì´ ìì‚°', cX, cY - 10);
        ctx.font = 'bold 14px sans-serif';
        ctx.fillStyle = dk ? '#e2e8f0' : '#1e293b';
        ctx.fillText(formatManWon(totalVal), cX, cY + 10);
        ctx.restore();
      }
    }],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 11 }, boxWidth: 12, padding: 10 } },
        tooltip: {
          callbacks: {
            label: ctx => {
              const pct = total > 0 ? (ctx.raw / total * 100).toFixed(1) : 0;
              return `${ctx.label}: ${formatManWon(ctx.raw)} (${pct}%)`;
            }
          }
        }
      }
    }
  });

  // ìì‚° í˜„í™© í…Œì´ë¸” (ë‚ ì§œ ê¸°ì¤€ + ì¹´í…Œê³ ë¦¬ë³„ í•­ëª© ì •ë¦¬)
  const now = new Date();
  const dateStr = `${now.getFullYear()}ë…„ ${now.getMonth()+1}ì›” ${now.getDate()}ì¼ ê¸°ì¤€`;
  document.getElementById('asset-date-label').textContent = dateStr;

  // ì¹´í…Œê³ ë¦¬ë³„ ê°œë³„ í•­ëª© ê·¸ë£¹í™” (ê¸ˆì•¡ ë‚´ë¦¼ì°¨ìˆœ)
  const catGroups = {};
  appData.assets.forEach(a => {
    if (!catGroups[a.category]) catGroups[a.category] = [];
    catGroups[a.category].push(a);
  });
  // ì¹´í…Œê³ ë¦¬ í•©ì‚° ê¸ˆì•¡ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  const sortedCats = Object.keys(catGroups).sort((a, b) => {
    const sumA = catGroups[a].reduce((s, x) => s + x.amount, 0);
    const sumB = catGroups[b].reduce((s, x) => s + x.amount, 0);
    return sumB - sumA;
  });

  let breakdownHTML = '';
  sortedCats.forEach(cat => {
    const items = catGroups[cat].sort((a, b) => b.amount - a.amount);
    const catTotal = items.reduce((s, x) => s + x.amount, 0);
    const catPct = total > 0 ? (catTotal / total * 100).toFixed(1) : '0.0';
    const color = catColors[cat] || '#999';

    breakdownHTML += `<div style="margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:${isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.03)'};border-radius:8px;border-left:4px solid ${color};">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-weight:700;font-size:0.9rem;">${cat}</span>
          <span style="font-size:0.75rem;color:var(--text2);">${catPct}%</span>
        </div>
        <span style="font-weight:700;font-size:0.95rem;color:${color};">${formatManWon(catTotal)}</span>
      </div>`;
    // ê°œë³„ í•­ëª© í‘œì‹œ
    if (items.length > 1) {
      items.forEach(item => {
        const itemPct = total > 0 ? (item.amount / total * 100).toFixed(1) : '0.0';
        breakdownHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 10px 4px 24px;font-size:0.82rem;">
          <span style="color:var(--text2);">â”œ ${item.name}</span>
          <span style="font-weight:600;">${formatManWon(item.amount)} <span style="color:var(--text2);font-size:0.72rem;">(${itemPct}%)</span></span>
        </div>`;
      });
    }
    // í•­ëª©ì´ 1ê°œì¸ ì¹´í…Œê³ ë¦¬: ê³„ì¢Œ ë³´ìœ  ì¢…ëª©ì—ì„œ ëŒ€í‘œ ì¢…ëª© í‘œì‹œ
    const acctTypeByCat = { 'í•´ì™¸ì£¼ì‹': 'í•´ì™¸ì£¼ì‹', 'êµ­ë‚´ì£¼ì‹/ETF': 'êµ­ë‚´ì£¼ì‹', 'ì•”í˜¸í™”í': 'ê¸°íƒ€' };
    if (items.length <= 1 && acctTypeByCat[cat]) {
      const targetType = acctTypeByCat[cat];
      const topHoldings = [];
      appData.accounts.forEach(acc => {
        if (acc.type === targetType) {
          (acc.holdings || []).forEach(h => {
            topHoldings.push({ name: h.name, eval: h.currentPrice * h.quantity });
          });
        }
      });
      topHoldings.sort((a, b) => b.eval - a.eval);
      const showCount = Math.min(2, topHoldings.length);
      for (let ti = 0; ti < showCount; ti++) {
        const th = topHoldings[ti];
        const hManWon = Math.round(th.eval / 10000);
        breakdownHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 10px 3px 24px;font-size:0.8rem;">
          <span style="color:var(--text2);">â”œ ${th.name}</span>
          <span style="font-weight:600;">${formatManWon(hManWon)} <span style="color:var(--text2);font-size:0.72rem;">(${total > 0 ? (hManWon / total * 100).toFixed(1) : '0.0'}%)</span></span>
        </div>`;
      }
      if (topHoldings.length > showCount) {
        breakdownHTML += `<div style="padding:2px 10px 2px 24px;font-size:0.75rem;color:var(--text2);">â”” ì™¸ ${topHoldings.length - showCount}ì¢…ëª©</div>`;
      }
    }
    breakdownHTML += `</div>`;
  });

  // í•˜ë‹¨ì— ì´ ìì‚° í‘œì‹œ
  breakdownHTML += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-top:4px;border-top:2px solid var(--primary);border-radius:0 0 8px 8px;">
    <span style="font-weight:700;font-size:0.95rem;">ğŸ’° ì´ ìì‚°</span>
    <span style="font-weight:800;font-size:1.1rem;color:var(--primary);">${formatManWon(total)}</span>
  </div>`;

  document.getElementById('asset-breakdown').innerHTML = breakdownHTML;
}

function updateAssetSummary(total) {
  const catMap = {};
  appData.assets.forEach(a => {
    catMap[a.category] = (catMap[a.category] || 0) + a.amount;
  });
  document.getElementById('asset-summary').innerHTML = `
    <div class="summary-card teal">
      <div class="label">ì´ ìì‚°</div>
      <div class="value">${formatManWon(total)}</div>
    </div>
    <div class="summary-card green">
      <div class="label">ê¸ˆìœµìì‚°</div>
      <div class="value">${formatManWon((catMap['ì—°ê¸ˆì €ì¶•/IRP']||0)+(catMap['ISA']||0)+(catMap['í•´ì™¸ì£¼ì‹']||0)+(catMap['êµ­ë‚´ì£¼ì‹/ETF']||0)+(catMap['ì•”í˜¸í™”í']||0)+(catMap['ì˜ˆì ê¸ˆ/í˜„ê¸ˆ']||0))}</div>
    </div>
    <div class="summary-card orange">
      <div class="label">ë¶€ë™ì‚°</div>
      <div class="value">${formatManWon(catMap['ë¶€ë™ì‚°']||0)}</div>
    </div>
    <div class="summary-card purple">
      <div class="label">ì—°ê¸ˆìì‚°</div>
      <div class="value">${formatManWon((catMap['ì‚¬í•™ì—°ê¸ˆ']||0)+(catMap['ì—°ê¸ˆì €ì¶•/IRP']||0)+(catMap['ë³´í—˜']||0))}</div>
    </div>
  `;
}

function deleteAsset(idx) {
  appData.assets.splice(idx, 1);
  saveData();
  renderAssets();
  showToast('ìì‚°ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// ===================================================================
//  íƒ­ 3: ê³„ì¢Œë³„ í¬íŠ¸í´ë¦¬ì˜¤
// ===================================================================

function addAccount() {
  openModal(`
    <h3>ê³„ì¢Œ ì¶”ê°€</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì†Œìœ ì</label>
        <select id="mac-owner">
          <option value="ë³¸ì¸">ë³¸ì¸</option>
          <option value="ë°°ìš°ì">ë°°ìš°ì</option>
        </select>
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œëª…</label>
        <input type="text" id="mac-name" placeholder="ì˜ˆ: ë¯¸ë˜ì—ì…‹ ì—°ê¸ˆì €ì¶•">
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œìœ í˜•</label>
        <select id="mac-type">
          <option value="ì—°ê¸ˆì €ì¶•">ì—°ê¸ˆì €ì¶•</option>
          <option value="IRP">IRP</option>
          <option value="ISA">ISA</option>
          <option value="í•´ì™¸ì£¼ì‹">í•´ì™¸ì£¼ì‹</option>
          <option value="êµ­ë‚´ì£¼ì‹">êµ­ë‚´ì£¼ì‹</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>
      <div class="form-group">
        <label>ì¦ê¶Œì‚¬</label>
        <input type="text" id="mac-broker" placeholder="ì˜ˆ: ë¯¸ë˜ì—ì…‹ì¦ê¶Œ">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveAccount(-1)">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function editAccount() {
  const idx = appData.currentAccountIdx;
  if (idx < 0) return;
  const acc = appData.accounts[idx];
  const types = ['ì—°ê¸ˆì €ì¶•','IRP','ISA','í•´ì™¸ì£¼ì‹','êµ­ë‚´ì£¼ì‹','ê¸°íƒ€'];
  const typeOptions = types.map(t => `<option value="${t}" ${acc.type === t ? 'selected' : ''}>${t}</option>`).join('');
  openModal(`
    <h3>ê³„ì¢Œ ìˆ˜ì •</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì†Œìœ ì</label>
        <select id="mac-owner"><option value="ë³¸ì¸" ${acc.owner === 'ë³¸ì¸' ? 'selected' : ''}>ë³¸ì¸</option><option value="ë°°ìš°ì" ${acc.owner === 'ë°°ìš°ì' ? 'selected' : ''}>ë°°ìš°ì</option></select>
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œëª…</label>
        <input type="text" id="mac-name" value="${acc.name}">
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œìœ í˜•</label>
        <select id="mac-type">${typeOptions}</select>
      </div>
      <div class="form-group">
        <label>ì¦ê¶Œì‚¬</label>
        <input type="text" id="mac-broker" value="${acc.broker || ''}">
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveAccount(${idx})">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveAccount(idx) {
  const account = {
    owner: document.getElementById('mac-owner').value || 'ë³¸ì¸',
    name: document.getElementById('mac-name').value || 'ê³„ì¢Œ',
    type: document.getElementById('mac-type').value,
    broker: document.getElementById('mac-broker').value || ''
  };
  if (idx !== undefined && idx >= 0) {
    account.holdings = appData.accounts[idx].holdings || [];
    appData.accounts[idx] = account;
  } else {
    account.holdings = [];
    appData.accounts.push(account);
  }
  saveData();
  renderAccounts();
  closeModalForce();
  showToast(idx >= 0 ? 'ê³„ì¢Œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ê³„ì¢Œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderAccounts() {
  const container = document.getElementById('account-tabs');
  const ownerGroups = { 'ë³¸ì¸': [], 'ë°°ìš°ì': [] };
  appData.accounts.forEach((acc, i) => {
    const owner = acc.owner || 'ë³¸ì¸';
    if (!ownerGroups[owner]) ownerGroups[owner] = [];
    ownerGroups[owner].push({ acc, idx: i });
  });

  let html = '';
  Object.entries(ownerGroups).forEach(([owner, accs]) => {
    if (accs.length === 0) return;
    const ownerColor = owner === 'ë³¸ì¸' ? '#3b82f6' : '#ec4899';
    html += `<div class="owner-group">
      <div class="owner-label" style="color:${ownerColor};font-weight:700;font-size:0.9rem;margin-bottom:6px;display:flex;align-items:center;gap:6px;">
        <span style="background:${ownerColor};color:white;padding:2px 10px;border-radius:12px;font-size:0.78rem;">${owner}</span>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">`;
    accs.forEach(({ acc, idx }) => {
      html += `<button class="account-tab ${appData.currentAccountIdx === idx ? 'active' : ''}" onclick="selectAccount(${idx})">
        ${acc.name} <span style="font-size:0.75rem;opacity:0.7;">(${acc.type})</span>
      </button>`;
    });
    html += '</div></div>';
  });
  container.innerHTML = html;

  if (appData.currentAccountIdx >= 0 && appData.currentAccountIdx < appData.accounts.length) {
    renderAccountDetail();
  } else {
    document.getElementById('account-detail').style.display = 'none';
  }
  renderAllHoldingsCharts();
}

function selectAccount(idx) {
  appData.currentAccountIdx = idx;
  renderAccounts();
}

function deleteCurrentAccount() {
  if (appData.currentAccountIdx < 0) return;
  appData.accounts.splice(appData.currentAccountIdx, 1);
  appData.currentAccountIdx = -1;
  saveData();
  renderAccounts();
  showToast('ê³„ì¢Œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

function renderAccountDetail() {
  const acc = appData.accounts[appData.currentAccountIdx];
  if (!acc) return;

  document.getElementById('account-detail').style.display = 'block';
  document.getElementById('account-detail-title').textContent = `[${acc.owner || 'ë³¸ì¸'}] ${acc.name} (${acc.broker}) - ì¢…ëª© ê´€ë¦¬`;

  const tbody = document.getElementById('holdings-body');
  const tfoot = document.getElementById('holdings-foot');

  if (acc.holdings.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text2);">ì¢…ëª©ì„ ì¶”ê°€í•˜ì„¸ìš”</td></tr>';
    tfoot.innerHTML = '';
    return;
  }

  let totalEval = 0, totalCost = 0, totalDiv = 0;
  // í‰ê°€ê¸ˆì•¡ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì›ë³¸ ì¸ë±ìŠ¤ ë³´ì¡´)
  const sortedHoldings = acc.holdings.map((h, i) => ({ h, i, evalAmt: h.currentPrice * h.quantity }))
    .sort((a, b) => b.evalAmt - a.evalAmt);
  tbody.innerHTML = sortedHoldings.map(({ h, i }) => {
    const evalAmt = h.currentPrice * h.quantity;
    const costAmt = h.purchasePrice * h.quantity;
    const returnPct = costAmt > 0 ? ((evalAmt - costAmt) / costAmt * 100) : 0;
    const annualDiv = evalAmt * (h.dividendYield / 100);
    totalEval += evalAmt;
    totalCost += costAmt;
    totalDiv += annualDiv;
    return `<tr>
      <td style="text-align:left;">${h.name}${h.stockCode ? '<br><span style="font-size:0.68rem;color:var(--text2);font-family:monospace;">'+h.stockCode+'</span>' : ''}</td>
      <td>${formatNum(h.purchasePrice)}ì›</td>
      <td>${formatNum(h.quantity)}</td>
      <td>${formatNum(h.currentPrice)}ì›</td>
      <td>${formatNum(evalAmt)}ì›</td>
      <td class="${returnPct >= 0 ? 'num-positive' : 'num-negative'}">${formatPercent(returnPct)}</td>
      <td>${h.dividendYield.toFixed(1)}%</td>
      <td>${formatNum(annualDiv)}ì›</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editHolding(${i})">ìˆ˜ì •</button>
        <button class="btn btn-sm btn-danger" onclick="deleteHolding(${i})">ì‚­ì œ</button>
      </td>
    </tr>`;
  }).join('');

  const totalReturn = totalCost > 0 ? ((totalEval - totalCost) / totalCost * 100) : 0;
  tfoot.innerHTML = `<tr style="font-weight:700;">
    <td>í•©ê³„</td><td></td><td></td><td></td>
    <td>${formatNum(totalEval)}ì›</td>
    <td class="${totalReturn >= 0 ? 'num-positive' : 'num-negative'}">${formatPercent(totalReturn)}</td>
    <td></td>
    <td>${formatNum(totalDiv)}ì›</td>
    <td></td>
  </tr>`;

}

// ì „ì²´ ê³„ì¢Œ ì¢…ëª© í•©ì‚° ì°¨íŠ¸
function renderAllHoldingsCharts() {
  // ì „ì²´ ì¢…ëª© í•©ì‚° (ë™ì¼ ì¢…ëª©ëª…ì€ í•©ì‚°)
  const holdingMap = {};
  appData.accounts.forEach(acc => {
    (acc.holdings || []).forEach(h => {
      const key = h.name;
      if (!holdingMap[key]) {
        holdingMap[key] = { name: h.name, totalEval: 0, totalCost: 0 };
      }
      holdingMap[key].totalEval += h.currentPrice * h.quantity;
      holdingMap[key].totalCost += h.purchasePrice * h.quantity;
    });
  });

  const allHoldings = Object.values(holdingMap);
  if (allHoldings.length === 0) {
    if (charts.holdingsPie) { charts.holdingsPie.destroy(); charts.holdingsPie = null; }
    if (charts.holdingsBar) { charts.holdingsBar.destroy(); charts.holdingsBar = null; }
    return;
  }

  // í‰ê°€ê¸ˆì•¡ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  allHoldings.sort((a, b) => b.totalEval - a.totalEval);

  const names = allHoldings.map(h => h.name);
  const evals = allHoldings.map(h => h.totalEval);
  const returns = allHoldings.map(h => h.totalCost > 0 ? ((h.totalEval - h.totalCost) / h.totalCost * 100) : 0);
  const totalEval = evals.reduce((s, v) => s + v, 0);
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48','#0ea5e9','#a855f7'];

  if (charts.holdingsPie) charts.holdingsPie.destroy();
  charts.holdingsPie = new Chart(document.getElementById('holdings-pie-chart'), {
    type: 'doughnut',
    data: {
      labels: names,
      datasets: [{ data: evals, backgroundColor: colors.slice(0, names.length), borderWidth: 2, borderColor: 'var(--card)' }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 10 } },
        tooltip: {
          callbacks: {
            label: ctx => {
              const pct = totalEval > 0 ? (ctx.raw / totalEval * 100).toFixed(1) : 0;
              return `${ctx.label}: ${formatNum(ctx.raw)} (${pct}%)`;
            }
          }
        }
      }
    }
  });

  // ìˆ˜ìµë¥  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ â†’ ìƒìœ„ 10ê°œ
  const returnData = allHoldings.map(h => ({
    name: h.name,
    returnPct: h.totalCost > 0 ? ((h.totalEval - h.totalCost) / h.totalCost * 100) : 0,
    totalEval: h.totalEval
  }));
  returnData.sort((a, b) => b.returnPct - a.returnPct);
  const top10 = returnData.slice(0, 10);

  // ì´ë¦„ ì¶•ì•½ í•¨ìˆ˜
  function shortenName(name) {
    if (name.length <= 10) return name;
    // TIGER â†’ T., KODEX â†’ K., SOL â†’ S. ë“± ì ‘ë‘ì–´ ì¶•ì•½
    let s = name
      .replace(/^TIGER\s+/, 'T.')
      .replace(/^KODEX\s+/, 'K.')
      .replace(/^SOL\s+/, 'S.')
      .replace(/^KOSEF\s+/, 'KF.')
      .replace(/^KBSTAR\s+/, 'KB.')
      .replace(/^HANARO\s+/, 'H.')
      .replace(/^ARIRANG\s+/, 'A.')
      .replace(/^ACE\s+/, 'A.');
    if (s.length > 14) s = s.substring(0, 13) + 'â€¦';
    return s;
  }

  const barLabels = top10.map(d => shortenName(d.name));
  const barData = top10.map(d => parseFloat(d.returnPct.toFixed(1)));
  const barColors = top10.map(d => d.returnPct >= 0 ? '#10b981' : '#ef4444');
  const isDarkMode = document.body.classList.contains('dark');

  if (charts.holdingsBar) charts.holdingsBar.destroy();
  charts.holdingsBar = new Chart(document.getElementById('holdings-bar-chart'), {
    type: 'bar',
    data: {
      labels: barLabels,
      datasets: [{
        label: 'ìˆ˜ìµë¥ ',
        data: barData,
        backgroundColor: barColors,
        borderRadius: 4,
        barThickness: 22
      }]
    },
    plugins: [{
      id: 'barValueLabel',
      afterDraw(chart) {
        const ctx = chart.ctx;
        const meta = chart.getDatasetMeta(0);
        meta.data.forEach((bar, i) => {
          const val = chart.data.datasets[0].data[i];
          ctx.save();
          ctx.font = 'bold 11px sans-serif';
          ctx.fillStyle = isDarkMode ? '#e2e8f0' : '#1a1a2e';
          ctx.textBaseline = 'middle';
          if (val >= 0) {
            ctx.textAlign = 'left';
            ctx.fillText(val + '%', bar.x + 6, bar.y);
          } else {
            ctx.textAlign = 'right';
            ctx.fillText(val + '%', bar.x - 6, bar.y);
          }
          ctx.restore();
        });
      }
    }],
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { right: 60 } },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            title: ctx => top10[ctx[0].dataIndex].name,
            label: ctx => `ìˆ˜ìµë¥ : ${ctx.raw}% | í‰ê°€ê¸ˆì•¡: ${formatNum(top10[ctx.dataIndex].totalEval)}ì›`
          }
        }
      },
      scales: {
        x: {
          ticks: { callback: v => v + '%' },
          grid: { color: isDarkMode ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.06)' }
        },
        y: {
          ticks: { font: { size: 11 } },
          grid: { display: false }
        }
      }
    }
  });

  renderDividendCharts();
}

// ë°°ë‹¹ê¸ˆ ë¶„ê¸°ë³„/ì›”ë³„ ì°¨íŠ¸
function renderDividendCharts() {
  const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#84cc16','#f97316','#6366f1','#14b8a6','#e11d48','#0ea5e9','#a855f7'];

  // ì¢…ëª©ë³„ ì›”ë³„ ë°°ë‹¹ê¸ˆ ê³„ì‚°
  const holdingDiv = {};
  appData.accounts.forEach(acc => {
    (acc.holdings || []).forEach(h => {
      const key = h.name;
      const evalAmt = h.currentPrice * h.quantity;
      const annualDiv = evalAmt * (h.dividendYield / 100);
      const freq = h.dividendFrequency || 'quarterly';
      if (!holdingDiv[key]) holdingDiv[key] = { name: h.name, monthly: new Array(12).fill(0), totalEval: 0 };
      holdingDiv[key].totalEval += evalAmt;
      // ë°°ë‹¹ì£¼ê¸°ì— ë”°ë¼ ì›”ë³„ ë°°ë¶„
      if (freq === 'monthly') {
        for (let m = 0; m < 12; m++) holdingDiv[key].monthly[m] += annualDiv / 12;
      } else if (freq === 'quarterly') {
        [2,5,8,11].forEach(m => holdingDiv[key].monthly[m] += annualDiv / 4);
      } else if (freq === 'semiannual') {
        [5,11].forEach(m => holdingDiv[key].monthly[m] += annualDiv / 2);
      } else {
        holdingDiv[key].monthly[11] += annualDiv;
      }
    });
  });

  const allDiv = Object.values(holdingDiv);
  if (allDiv.length === 0) {
    if (charts.divQuarterly) { charts.divQuarterly.destroy(); charts.divQuarterly = null; }
    if (charts.divMonthly) { charts.divMonthly.destroy(); charts.divMonthly = null; }
    document.getElementById('div-quarterly-total').textContent = '';
    document.getElementById('div-monthly-total').textContent = '';
    return;
  }

  // í‰ê°€ê¸ˆì•¡ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
  allDiv.sort((a, b) => b.totalEval - a.totalEval);

  // ì´ ì—°ë°°ë‹¹ê¸ˆ ê³„ì‚°
  const totalAnnualDiv = allDiv.reduce((sum, h) => sum + h.monthly.reduce((s, v) => s + v, 0), 0);
  document.getElementById('div-quarterly-total').textContent = `ì—° ë°°ë‹¹ê¸ˆ: ${formatNum(Math.round(totalAnnualDiv))}ì›`;
  document.getElementById('div-monthly-total').textContent = `ì›” í‰ê· : ${formatNum(Math.round(totalAnnualDiv / 12))}ì›`;

  // === ë¶„ê¸°ë³„ ë°°ë‹¹ê¸ˆ ì°¨íŠ¸ ===
  const quarterLabels = ['1ë¶„ê¸° (1~3ì›”)', '2ë¶„ê¸° (4~6ì›”)', '3ë¶„ê¸° (7~9ì›”)', '4ë¶„ê¸° (10~12ì›”)'];
  const quarterDatasets = allDiv.map((h, i) => ({
    label: h.name,
    data: [
      h.monthly[0] + h.monthly[1] + h.monthly[2],
      h.monthly[3] + h.monthly[4] + h.monthly[5],
      h.monthly[6] + h.monthly[7] + h.monthly[8],
      h.monthly[9] + h.monthly[10] + h.monthly[11]
    ].map(v => Math.round(v)),
    backgroundColor: colors[i % colors.length],
    borderRadius: 4
  }));

  // ìŠ¤íƒ ë°” ìœ„ì— ì´ì•¡ í‘œì‹œ í”ŒëŸ¬ê·¸ì¸
  const stackTotalPlugin = {
    id: 'stackTotal',
    afterDraw(chart) {
      const ctx = chart.ctx;
      const dsCount = chart.data.datasets.length;
      if (dsCount === 0) return;
      const isDark = document.body.classList.contains('dark');
      chart.data.labels.forEach((_, i) => {
        let total = 0;
        chart.data.datasets.forEach(ds => { total += ds.data[i] || 0; });
        if (total <= 0) return;
        // ë§¨ ìœ„ ë°ì´í„°ì…‹ì˜ ë°” ìœ„ì¹˜ ì°¾ê¸°
        let topY = Infinity;
        for (let d = dsCount - 1; d >= 0; d--) {
          const meta = chart.getDatasetMeta(d);
          if (meta.hidden) continue;
          const bar = meta.data[i];
          if (bar && bar.y < topY) topY = bar.y;
        }
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.font = 'bold 12px sans-serif';
        ctx.fillStyle = isDark ? '#e2e8f0' : '#1a1a2e';
        ctx.fillText(formatNum(total) + 'ì›', chart.getDatasetMeta(0).data[i].x, topY - 6);
        ctx.restore();
      });
    }
  };

  if (charts.divQuarterly) charts.divQuarterly.destroy();
  charts.divQuarterly = new Chart(document.getElementById('dividend-quarterly-chart'), {
    type: 'bar',
    data: { labels: quarterLabels, datasets: quarterDatasets },
    plugins: [stackTotalPlugin],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 25 } },
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 10 } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatNum(ctx.raw)}ì›` } }
      },
      scales: {
        x: { stacked: true },
        y: { stacked: true, ticks: { callback: v => formatNum(v) + 'ì›' } }
      }
    }
  });

  // === ì›”ë³„ ë°°ë‹¹ê¸ˆ ì°¨íŠ¸ ===
  const monthLabels = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const monthDatasets = allDiv.map((h, i) => ({
    label: h.name,
    data: h.monthly.map(v => Math.round(v)),
    backgroundColor: colors[i % colors.length],
    borderRadius: 4
  }));

  if (charts.divMonthly) charts.divMonthly.destroy();
  charts.divMonthly = new Chart(document.getElementById('dividend-monthly-chart'), {
    type: 'bar',
    data: { labels: monthLabels, datasets: monthDatasets },
    plugins: [stackTotalPlugin],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 25 } },
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 10 }, boxWidth: 10 } },
        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatNum(ctx.raw)}ì›` } }
      },
      scales: {
        x: { stacked: true },
        y: { stacked: true, ticks: { callback: v => formatNum(v) + 'ì›' } }
      }
    }
  });
}

function addHolding() {
  openModal(`
    <h3>ì¢…ëª© ì¶”ê°€</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì¢…ëª©ëª…</label>
        <input type="text" id="mh-name" placeholder="ì˜ˆ: TIGER ë¯¸êµ­S&P500">
      </div>
      <div class="form-group">
        <label>ì¢…ëª©ì½”ë“œ</label>
        <input type="text" id="mh-code" placeholder="ì˜ˆ: 360750" style="font-family:monospace;">
        <small style="color:var(--text2);font-size:0.7rem;">í•œêµ­:ì¢…ëª©ì½”ë“œ(360750) / ë¯¸êµ­:í‹°ì»¤(TSLA) / ì½”ì¸:C:í‹°ì»¤(C:BTC)</small>
      </div>
      <div class="form-group">
        <label>ë§¤ìˆ˜ë‹¨ê°€</label>
        <input type="number" id="mh-price" value="0" step="1">
      </div>
      <div class="form-group">
        <label>ìˆ˜ëŸ‰</label>
        <input type="number" id="mh-qty" value="0" step="0.001">
      </div>
      <div class="form-group">
        <label>í˜„ì¬ê°€</label>
        <input type="number" id="mh-current" value="0" step="1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ë¥  (%)</label>
        <input type="number" id="mh-div" value="0" step="0.1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ì£¼ê¸°</label>
        <select id="mh-freq">
          <option value="monthly">ì›”ë°°ë‹¹</option>
          <option value="quarterly" selected>ë¶„ê¸°ë°°ë‹¹</option>
          <option value="semiannual">ë°˜ê¸°ë°°ë‹¹</option>
          <option value="annual">ì—°ë°°ë‹¹</option>
        </select>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveHolding(-1)">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function editHolding(idx) {
  const acc = appData.accounts[appData.currentAccountIdx];
  const h = acc.holdings[idx];
  openModal(`
    <h3>ì¢…ëª© ìˆ˜ì •</h3>
    <div class="form-grid">
      <div class="form-group">
        <label>ì¢…ëª©ëª…</label>
        <input type="text" id="mh-name" value="${h.name}">
      </div>
      <div class="form-group">
        <label>ì¢…ëª©ì½”ë“œ</label>
        <input type="text" id="mh-code" value="${h.stockCode || ''}" placeholder="ì˜ˆ: 360750" style="font-family:monospace;">
        <small style="color:var(--text2);font-size:0.7rem;">í•œêµ­:ì¢…ëª©ì½”ë“œ(360750) / ë¯¸êµ­:í‹°ì»¤(TSLA) / ì½”ì¸:C:í‹°ì»¤(C:BTC)</small>
      </div>
      <div class="form-group">
        <label>ë§¤ìˆ˜ë‹¨ê°€</label>
        <input type="number" id="mh-price" value="${h.purchasePrice}" step="1">
      </div>
      <div class="form-group">
        <label>ìˆ˜ëŸ‰</label>
        <input type="number" id="mh-qty" value="${h.quantity}" step="0.001">
      </div>
      <div class="form-group">
        <label>í˜„ì¬ê°€</label>
        <input type="number" id="mh-current" value="${h.currentPrice}" step="1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ë¥  (%)</label>
        <input type="number" id="mh-div" value="${h.dividendYield}" step="0.1">
      </div>
      <div class="form-group">
        <label>ë°°ë‹¹ì£¼ê¸°</label>
        <select id="mh-freq">
          <option value="monthly" ${(h.dividendFrequency||'quarterly')==='monthly'?'selected':''}>ì›”ë°°ë‹¹</option>
          <option value="quarterly" ${(h.dividendFrequency||'quarterly')==='quarterly'?'selected':''}>ë¶„ê¸°ë°°ë‹¹</option>
          <option value="semiannual" ${(h.dividendFrequency||'quarterly')==='semiannual'?'selected':''}>ë°˜ê¸°ë°°ë‹¹</option>
          <option value="annual" ${(h.dividendFrequency||'quarterly')==='annual'?'selected':''}>ì—°ë°°ë‹¹</option>
        </select>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveHolding(${idx})">ì €ì¥</button>
      <button class="btn btn-danger" onclick="closeModalForce()">ì·¨ì†Œ</button>
    </div>
  `);
}

function saveHolding(idx) {
  const holding = {
    name: document.getElementById('mh-name').value || 'ì¢…ëª©',
    stockCode: document.getElementById('mh-code').value.trim() || '',
    purchasePrice: parseFloat(document.getElementById('mh-price').value) || 0,
    quantity: parseFloat(document.getElementById('mh-qty').value) || 0,
    currentPrice: parseFloat(document.getElementById('mh-current').value) || 0,
    dividendYield: parseFloat(document.getElementById('mh-div').value) || 0,
    dividendFrequency: document.getElementById('mh-freq').value || 'quarterly'
  };
  const acc = appData.accounts[appData.currentAccountIdx];
  if (idx < 0) {
    acc.holdings.push(holding);
  } else {
    acc.holdings[idx] = holding;
  }
  saveData();
  renderAccountDetail();
  renderAllHoldingsCharts();
  closeModalForce();
  showToast(idx < 0 ? 'ì¢…ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì¢…ëª©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function deleteHolding(idx) {
  appData.accounts[appData.currentAccountIdx].holdings.splice(idx, 1);
  saveData();
  renderAccountDetail();
  renderAllHoldingsCharts();
  showToast('ì¢…ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
}

// --- ì‹¤ì‹œê°„ í˜„ì¬ê°€ ê°±ì‹  (í•œêµ­ì£¼ì‹ + ë¯¸êµ­ì£¼ì‹ + ì•”í˜¸í™”í) ---
async function fetchCurrentPrices() {
  const btn = document.getElementById('btn-fetch-prices');
  const statusEl = document.getElementById('price-update-status');
  const PROXY = 'https://api.codetabs.com/v1/proxy/?quest=';

  // ì „ì²´ ê³„ì¢Œì˜ ì¢…ëª©ì½”ë“œê°€ ìˆëŠ” ì¢…ëª© ìˆ˜ì§‘ & ë¶„ë¥˜
  const targets = [];
  appData.accounts.forEach((acc, ai) => {
    (acc.holdings || []).forEach((h, hi) => {
      if (h.stockCode && h.stockCode.trim()) {
        const code = h.stockCode.trim();
        let type = 'KR'; // ê¸°ë³¸: í•œêµ­ ì£¼ì‹ (ìˆ«ì)
        if (/^C:/i.test(code)) type = 'CRYPTO'; // C:BTC â†’ ì•”í˜¸í™”í
        else if (/^[A-Za-z]/.test(code)) type = 'US'; // ì˜ë¬¸ â†’ ë¯¸êµ­ ì£¼ì‹
        targets.push({ accIdx: ai, holdIdx: hi, code, name: h.name, type });
      }
    });
  });

  if (targets.length === 0) {
    showToast('ì¢…ëª©ì½”ë“œê°€ ì…ë ¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.\nì¢…ëª© ìˆ˜ì •ì—ì„œ ì¢…ëª©ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    return;
  }

  // UI ì—…ë°ì´íŠ¸ - ë¡œë”© ìƒíƒœ
  btn.disabled = true;
  btn.innerHTML = 'â³ ì¡°íšŒì¤‘...';
  statusEl.style.display = 'block';

  const hasUS = targets.some(t => t.type === 'US');
  const hasCrypto = targets.some(t => t.type === 'CRYPTO');
  let usdKrw = 0;

  // ë¯¸êµ­ ì£¼ì‹ì´ ìˆìœ¼ë©´ í™˜ìœ¨ ë¨¼ì € ì¡°íšŒ
  if (hasUS) {
    statusEl.innerHTML = `<span style="color:var(--primary);">ğŸ’± USD/KRW í™˜ìœ¨ ì¡°íšŒì¤‘...</span>`;
    try {
      const fxResp = await fetch(PROXY + encodeURIComponent('https://api.stock.naver.com/marketindex/exchange/FX_USDKRW'));
      const fxData = await fxResp.json();
      usdKrw = parseFloat(fxData.exchangeInfo.closePrice.replace(/,/g, ''));
    } catch (e) {
      usdKrw = 1450;
    }
  }

  // ì•”í˜¸í™”í ì¼ê´„ ì¡°íšŒ (ì—…ë¹„íŠ¸ API - í•œ ë²ˆì˜ í˜¸ì¶œë¡œ ëª¨ë“  ì½”ì¸ ì¡°íšŒ)
  const cryptoTargets = targets.filter(t => t.type === 'CRYPTO');
  const cryptoPriceMap = {};
  if (cryptoTargets.length > 0) {
    statusEl.innerHTML = `<span style="color:var(--primary);">ğŸª™ ì•”í˜¸í™”í ì‹œì„¸ ì¡°íšŒì¤‘...</span>`;
    try {
      const markets = cryptoTargets.map(t => 'KRW-' + t.code.replace(/^C:/i, '').toUpperCase()).join(',');
      const cResp = await fetch(PROXY + encodeURIComponent(`https://api.upbit.com/v1/ticker?markets=${markets}`));
      const cData = await cResp.json();
      if (Array.isArray(cData)) {
        cData.forEach(c => {
          const symbol = c.market.replace('KRW-', '');
          cryptoPriceMap[symbol] = Math.round(c.trade_price);
        });
      }
    } catch (e) { /* ê°œë³„ ì¡°íšŒë¡œ í´ë°± */ }
  }

  const infoArr = [];
  if (hasUS) infoArr.push('í™˜ìœ¨: ' + formatNum(Math.round(usdKrw)) + 'ì›/$');
  statusEl.innerHTML = `<span style="color:var(--primary);">ğŸ“¡ ${targets.length}ê°œ ì¢…ëª© í˜„ì¬ê°€ ì¡°íšŒì¤‘...${infoArr.length ? ' (' + infoArr.join(', ') + ')' : ''}</span>`;

  let successCount = 0;
  let failCount = 0;
  const failList = [];

  for (let t = 0; t < targets.length; t++) {
    const { accIdx, holdIdx, code, name, type } = targets[t];
    const flag = type === 'US' ? ' ğŸ‡ºğŸ‡¸' : type === 'CRYPTO' ? ' ğŸª™' : ' ğŸ‡°ğŸ‡·';
    statusEl.innerHTML = `<span style="color:var(--primary);">ğŸ“¡ ì¡°íšŒì¤‘ (${t + 1}/${targets.length}): ${name} [${code}]${flag}</span>`;

    try {
      let price = 0;

      if (type === 'CRYPTO') {
        // ì•”í˜¸í™”í: ì—…ë¹„íŠ¸ (ì´ë¯¸ ì¼ê´„ ì¡°íšŒ ì™„ë£Œ)
        const symbol = code.replace(/^C:/i, '').toUpperCase();
        if (cryptoPriceMap[symbol]) {
          price = cryptoPriceMap[symbol];
        } else {
          // ì¼ê´„ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê°œë³„ ì¡°íšŒ
          const cResp = await fetch(PROXY + encodeURIComponent(`https://api.upbit.com/v1/ticker?markets=KRW-${symbol}`));
          const cData = await cResp.json();
          if (Array.isArray(cData) && cData.length > 0) {
            price = Math.round(cData[0].trade_price);
          } else {
            throw new Error('ì—…ë¹„íŠ¸ ì¡°íšŒ ì‹¤íŒ¨');
          }
        }
      } else if (type === 'US') {
        // ë¯¸êµ­ ì£¼ì‹: ë‚˜ìŠ¤ë‹¥(.O) â†’ NYSE(ì ‘ë¯¸ì‚¬ ì—†ìŒ) ìˆœì„œ
        const ticker = code.toUpperCase();
        let data = null;
        try {
          const resp1 = await fetch(PROXY + encodeURIComponent(`https://api.stock.naver.com/stock/${ticker}.O/basic`));
          const d1 = await resp1.json();
          if (d1.closePrice) data = d1;
        } catch(e) {}
        if (!data) {
          try {
            const resp2 = await fetch(PROXY + encodeURIComponent(`https://api.stock.naver.com/stock/${ticker}/basic`));
            const d2 = await resp2.json();
            if (d2.closePrice) data = d2;
          } catch(e) {}
        }
        if (data && data.closePrice) {
          const usdPrice = parseFloat(data.closePrice.replace(/[,$]/g, ''));
          price = Math.round(usdPrice * usdKrw);
        }
        // 3ì°¨: Yahoo Finance í´ë°± (Naver ë¯¸ì§€ì› ì¢…ëª©ìš©)
        if (price === 0) {
          try {
            statusEl.innerHTML = `<span style="color:#f59e0b;">âš ï¸ ${name}: ë„¤ì´ë²„ ë¯¸ì§€ì› â†’ Yahoo Finance ì¡°íšŒì¤‘...</span>`;
            const yUrl = 'https://corsproxy.io/?' + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`);
            const yResp = await fetch(yUrl);
            const yData = await yResp.json();
            const yPrice = yData?.chart?.result?.[0]?.meta?.regularMarketPrice;
            if (yPrice && yPrice > 0) {
              price = Math.round(yPrice * usdKrw);
            }
          } catch(e) {}
        }
        if (price === 0) {
          throw new Error('ë¯¸êµ­ ì£¼ì‹ ì¡°íšŒ ì‹¤íŒ¨ (Naver+Yahoo)');
        }
      } else {
        // í•œêµ­ ì£¼ì‹
        const url = PROXY + encodeURIComponent(`https://m.stock.naver.com/api/stock/${code}/basic`);
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (data.closePrice) {
          price = parseInt(data.closePrice.replace(/,/g, ''), 10);
        } else {
          throw new Error('closePrice ì—†ìŒ');
        }
      }

      if (price > 0) {
        appData.accounts[accIdx].holdings[holdIdx].currentPrice = price;
        successCount++;
      } else {
        throw new Error('ê°€ê²© íŒŒì‹± ì‹¤íŒ¨');
      }
    } catch (err) {
      failCount++;
      failList.push(`${name}(${code})`);
    }

    // API ë¶€í•˜ ë°©ì§€ ë”œë ˆì´ (ì•”í˜¸í™”íëŠ” ì´ë¯¸ ì¼ê´„ ì¡°íšŒí•˜ë¯€ë¡œ ì§§ê²Œ)
    if (t < targets.length - 1 && type !== 'CRYPTO') {
      await new Promise(r => setTimeout(r, 500));
    }
  }

  // ì €ì¥ ë° UI ê°±ì‹ 
  saveData();
  renderAccountDetail();
  renderAllHoldingsCharts();

  // ê²°ê³¼ í‘œì‹œ
  btn.disabled = false;
  btn.innerHTML = 'ğŸ“¡ í˜„ì¬ê°€ ê°±ì‹ ';

  const now = new Date();
  const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
  const extras = [];
  if (hasUS) extras.push(`ğŸ’± í™˜ìœ¨ ${formatNum(Math.round(usdKrw))}ì›/$`);
  if (hasCrypto) extras.push('ğŸª™ ì—…ë¹„íŠ¸');
  const extraStr = extras.length ? ' Â· ' + extras.join(' Â· ') : '';

  if (failCount === 0) {
    statusEl.innerHTML = `<span style="color:#10b981;">âœ… ${successCount}ê°œ ì¢…ëª© í˜„ì¬ê°€ ê°±ì‹  ì™„ë£Œ${extraStr} (${timeStr})</span>`;
    showToast(`${successCount}ê°œ ì¢…ëª© í˜„ì¬ê°€ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
  } else {
    statusEl.innerHTML = `<span style="color:#10b981;">âœ… ì„±ê³µ ${successCount}ê°œ</span> Â· <span style="color:#ef4444;">âŒ ì‹¤íŒ¨ ${failCount}ê°œ: ${failList.join(', ')}</span>${extraStr} <span style="color:var(--text2);">(${timeStr})</span>`;
    showToast(`${successCount}ê°œ ì„±ê³µ, ${failCount}ê°œ ì‹¤íŒ¨`);
  }

  setTimeout(() => { statusEl.style.display = 'none'; }, 15000);
}

// ===================================================================
//  íƒ­ 4: ì„¤ì •
// ===================================================================

function saveSettings() {
  // ë³¸ì¸ í”„ë¡œí•„
  if (!appData.settings.owner) appData.settings.owner = {};
  appData.settings.owner.name = document.getElementById('set-owner-name').value;
  appData.settings.owner.nickname = document.getElementById('set-owner-nickname').value;
  appData.settings.owner.gender = document.getElementById('set-owner-gender').value;
  appData.settings.owner.birthYear = parseInt(document.getElementById('set-owner-birthyear').value) || 1970;

  // ë°°ìš°ì í”„ë¡œí•„
  if (!appData.settings.spouse) appData.settings.spouse = {};
  appData.settings.spouse.name = document.getElementById('set-spouse-name').value;
  appData.settings.spouse.nickname = document.getElementById('set-spouse-nickname').value;
  appData.settings.spouse.gender = document.getElementById('set-spouse-gender').value;
  appData.settings.spouse.birthYear = parseInt(document.getElementById('set-spouse-birthyear').value) || 1972;

  // birth í˜¸í™˜ ìœ ì§€ (ë³¸ì¸ ì¶œìƒì—°ë„ ê¸°ì¤€)
  appData.settings.birth = appData.settings.owner.birthYear + '-01';

  appData.settings.retireYear = parseInt(document.getElementById('set-retireyear').value) || 2029;
  appData.settings.inflationRate = parseFloat(document.getElementById('set-inflation').value) || 2;
  appData.settings.dividendGrowthRate = parseFloat(document.getElementById('set-divgrowth').value) || 2.5;
  appData.settings.pensionTaxRate = parseFloat(document.getElementById('set-pensiontax').value) || 3.3;
  appData.settings.dividendTaxRate = parseFloat(document.getElementById('set-divtax').value) || 15.4;
  saveData();
  calculateCashflow();
  showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function loadSettings() {
  const o = appData.settings.owner || {};
  const s = appData.settings.spouse || {};
  document.getElementById('set-owner-name').value = o.name || '';
  document.getElementById('set-owner-nickname').value = o.nickname || '';
  document.getElementById('set-owner-gender').value = o.gender || 'male';
  document.getElementById('set-owner-birthyear').value = o.birthYear || 1970;
  document.getElementById('set-spouse-name').value = s.name || '';
  document.getElementById('set-spouse-nickname').value = s.nickname || '';
  document.getElementById('set-spouse-gender').value = s.gender || 'female';
  document.getElementById('set-spouse-birthyear').value = s.birthYear || 1972;

  document.getElementById('set-retireyear').value = appData.settings.retireYear || 2029;
  document.getElementById('set-inflation').value = appData.settings.inflationRate;
  document.getElementById('set-divgrowth').value = appData.settings.dividendGrowthRate;
  document.getElementById('set-pensiontax').value = appData.settings.pensionTaxRate;
  document.getElementById('set-divtax').value = appData.settings.dividendTaxRate;
}

function exportData() {
  const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ì€í‡´ìì‚°ê´€ë¦¬_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸° ë˜ì—ˆìŠµë‹ˆë‹¤');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      appData = { ...appData, ...imported };
      appData.settings = { ...appData.settings, ...(imported.settings || {}) };
      saveData();
      loadSettings();
      renderIncomes();
      renderExpenses();
      renderAssets();
      renderAccounts();
      calculateCashflow();
      showToast('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤');
    } catch(err) {
      showToast('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function resetAllData() {
  if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
  localStorage.removeItem('retireApp');
  location.reload();
}

// ===================================================================
//  ìƒ˜í”Œ ë°ì´í„° (ì²« ì‹¤í–‰ì‹œ)
// ===================================================================

function loadSampleData() {
  if (appData.incomes.length > 0 || appData.assets.length > 0) return;

  // í”„ë¡œí•„ ê¸°ë³¸ê°’ (ì„ì˜ì˜ ì˜ˆì‹œ)
  appData.settings.owner = { name: 'ì‚¬ìš©ìA', nickname: 'ë³¸ì¸', gender: 'male', birthYear: 1975 };
  appData.settings.spouse = { name: 'ì‚¬ìš©ìB', nickname: 'ë°°ìš°ì', gender: 'female', birthYear: 1977 };
  appData.settings.birth = '1975-01';

  // ì˜ˆì‹œ ìˆ˜ì…ì› (ì—°ê¸ˆ + íˆ¬ììˆ˜ì… + ê¸°íƒ€ìˆ˜ì…)
  appData.incomes = [
    { type:'pension', owner:'ë³¸ì¸', provider:'(ì˜ˆì‹œ) ì—°ê¸ˆê³µë‹¨', product:'í‡´ì§ì—°ê¸ˆ', startYear:2030, endYear:2060, monthlyAmount:200, growthRate:1.0 },
    { type:'pension', owner:'ë³¸ì¸', provider:'(ì˜ˆì‹œ) ì¦ê¶Œì‚¬', product:'ì—°ê¸ˆì €ì¶• ETF', startYear:2035, endYear:2055, monthlyAmount:100, growthRate:2.0 },
    { type:'investment', owner:'ë³¸ì¸', provider:'(ì˜ˆì‹œ) ì¦ê¶Œì‚¬', product:'ë°°ë‹¹ê¸ˆ ìˆ˜ì…', startYear:2030, endYear:2060, monthlyAmount:50, growthRate:3.0 },
    { type:'other', owner:'ë³¸ì¸', provider:'(ì˜ˆì‹œ) ê¸°íƒ€', product:'ì„ëŒ€ ìˆ˜ì…', startYear:2030, endYear:2050, monthlyAmount:80, growthRate:1.5 },
  ];

  // ì˜ˆì‹œ ì§€ì¶œ (ê³ ì •ë¹„ + ë³€ë™ë¹„)
  appData.expenses = [
    { name:'ìƒí™œë¹„', type:'fixed', monthlyAmount:300, startYear:2030, endYear:2060, growthRate:2.0 },
    { name:'ë³´í—˜/ì˜ë£Œ', type:'fixed', monthlyAmount:30, startYear:2030, endYear:2060, growthRate:3.0 },
    { name:'ì—¬í–‰/ë ˆì €', type:'variable', monthlyAmount:50, startYear:2030, endYear:2060, growthRate:2.0 },
    { name:'ê²½ì¡°ì‚¬/ìš©ëˆ', type:'variable', monthlyAmount:20, startYear:2030, endYear:2060, growthRate:1.0 },
  ];

  // ì˜ˆì‹œ ìì‚° (ê°„ì†Œí™”)
  appData.assets = [
    { category:'ì—°ê¸ˆ', name:'(ì˜ˆì‹œ) í‡´ì§ì—°ê¸ˆ ì ë¦½ê¸ˆ', amount:30000 },
    { category:'ì˜ˆì ê¸ˆ/í˜„ê¸ˆ', name:'(ì˜ˆì‹œ) ì˜ˆì ê¸ˆ', amount:5000 },
  ];

  // ì˜ˆì‹œ ê³„ì¢Œ (ê°„ì†Œí™”)
  appData.accounts = [
    {
      owner: 'ë³¸ì¸', name: '(ì˜ˆì‹œ) ì—°ê¸ˆì €ì¶• ê³„ì¢Œ', type: 'ì—°ê¸ˆì €ì¶•', broker: 'ì¦ê¶Œì‚¬',
      holdings: [
        { name:'(ì˜ˆì‹œ) ETFì¢…ëª©', stockCode:'', purchasePrice:10000, quantity:10, currentPrice:12000, dividendYield:2.0, dividendFrequency:'quarterly' },
      ]
    },
    {
      owner: 'ë°°ìš°ì', name: '(ì˜ˆì‹œ) IRP ê³„ì¢Œ', type: 'IRP', broker: 'ì¦ê¶Œì‚¬',
      holdings: [
        { name:'(ì˜ˆì‹œ) ë°°ë‹¹ETF', stockCode:'', purchasePrice:9000, quantity:15, currentPrice:10500, dividendYield:3.0, dividendFrequency:'monthly' },
      ]
    },
  ];

  saveData();
}

// ===================================================================
//  ì´ˆê¸°í™”
// ===================================================================

function init() {
  // í…Œë§ˆ
  if (localStorage.getItem('theme') === 'dark') {
    document.body.classList.add('dark');
    document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
  }

  loadData();
  loadSampleData();
  loadSettings();
  renderIncomes();
  renderExpenses();
  calculateCashflow();
  renderFooters();
}

// ì€í‡´ ê´€ë ¨ ëª…ì–¸
const retirementQuotes = [
  { text: "ì€í‡´ëŠ” ëì´ ì•„ë‹ˆë¼, ì§„ì •í•œ ì‚¶ì˜ ì‹œì‘ì´ë‹¤.", author: "â€” ë¡œë²„íŠ¸ ì•„ì»¤ë§Œ" },
  { text: "ë…¸í›„ ì¤€ë¹„ì˜ ê°€ì¥ ì¢‹ì€ ì‹œê¸°ëŠ” 20ë…„ ì „ì´ì—ˆê³ , ê·¸ ë‹¤ìŒìœ¼ë¡œ ì¢‹ì€ ì‹œê¸°ëŠ” ë°”ë¡œ ì§€ê¸ˆì´ë‹¤.", author: "â€” ì¤‘êµ­ ì†ë‹´ ì‘ìš©" },
  { text: "ë³µë¦¬ëŠ” ì„¸ê³„ 8ë²ˆì§¸ ë¶ˆê°€ì‚¬ì˜ë‹¤. ì´í•´í•˜ëŠ” ìëŠ” ë²Œê³ , ëª¨ë¥´ëŠ” ìëŠ” ì§€ë¶ˆí•œë‹¤.", author: "â€” ì•¨ë²„íŠ¸ ì•„ì¸ìŠˆíƒ€ì¸" },
  { text: "ë¶€ìê°€ ë˜ëŠ” ë¹„ê²°ì€ ê°„ë‹¨í•˜ë‹¤. ì§€ì¶œì„ ìˆ˜ì…ë³´ë‹¤ ì ê²Œ í•˜ê³ , ë‚˜ë¨¸ì§€ë¥¼ íˆ¬ìí•˜ë¼.", author: "â€” ë²¤ì €ë¯¼ í”„ë­í´ë¦°" },
  { text: "ì¸ìƒì—ì„œ ê°€ì¥ í° ìœ„í—˜ì€ ì•„ë¬´ëŸ° ìœ„í—˜ë„ ê°ìˆ˜í•˜ì§€ ì•ŠëŠ” ê²ƒì´ë‹¤.", author: "â€” ë§ˆí¬ ì €ì»¤ë²„ê·¸" },
  { text: "ë‹¹ì‹ ì˜ ë¯¸ë˜ëŠ” ì˜¤ëŠ˜ ë¬´ì—‡ì„ í•˜ëŠëƒì— ë‹¬ë ¤ìˆë‹¤.", author: "â€” ë§ˆí•˜íŠ¸ë§ˆ ê°„ë””" },
  { text: "ëˆì€ ììœ ë¥¼ ì‚¬ëŠ” ê²ƒì´ë‹¤. ë¬´ì—‡ë³´ë‹¤ ì‹œê°„ì˜ ììœ ë¥¼.", author: "â€” ëª¨ê±´ í•˜ìš°ì ˆ" },
  { text: "ì€í‡´ í›„ í–‰ë³µì˜ ì—´ì‡ ëŠ” ëˆì´ ì•„ë‹ˆë¼, ì˜ë¯¸ ìˆëŠ” ì¼ìƒì„ ë§Œë“œëŠ” ê²ƒì´ë‹¤.", author: "â€” ì–´ë‹ˆ ì ¤ë¦°ìŠ¤í‚¤" },
  { text: "ì €ì¶•ì€ ë¯¸ë˜ì˜ ë‚˜ì—ê²Œ ë³´ë‚´ëŠ” ê°€ì¥ í™•ì‹¤í•œ ì„ ë¬¼ì´ë‹¤.", author: "â€” ì›ŒëŸ° ë²„í•" },
  { text: "ì‹œê°„ê³¼ ë³µë¦¬ëŠ” ìµœê³ ì˜ íŒŒíŠ¸ë„ˆë‹¤. ì¼ì° ì‹œì‘í•˜ë©´ ì ê²Œ ë„£ì–´ë„ í¬ê²Œ ìë€ë‹¤.", author: "â€” ì¡´ ë³´ê¸€" },
  { text: "ë‹¹ì‹ ì´ ì ìëŠ” ë™ì•ˆì—ë„ ëˆì´ ì¼í•˜ê²Œ í•˜ì§€ ì•Šìœ¼ë©´, ì£½ì„ ë•Œê¹Œì§€ ì¼í•´ì•¼ í•œë‹¤.", author: "â€” ì›ŒëŸ° ë²„í•" },
  { text: "ì€í‡´ ê³„íšì´ ì—†ë‹¤ë©´, ë‹¹ì‹ ì€ ë‹¤ë¥¸ ì‚¬ëŒì˜ ê³„íšì— ì†í•˜ê²Œ ë  ê²ƒì´ë‹¤.", author: "â€” ì§ ë¡ " },
  { text: "ì¬ì •ì  ììœ ë€ ì„ íƒí•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ë‹¤.", author: "â€” ë°ì´ë¸Œ ë¨ì§€" },
  { text: "ì˜¤ëŠ˜ì˜ ì‘ì€ ì ˆì•½ì´ ë‚´ì¼ì˜ í° ììœ ê°€ ëœë‹¤.", author: "â€” ë²¤ì €ë¯¼ í”„ë­í´ë¦°" },
  { text: "í–‰ë³µí•œ ì€í‡´ëŠ” ì €ì ˆë¡œ ì˜¤ì§€ ì•ŠëŠ”ë‹¤. ê³„íší•˜ê³  ì¤€ë¹„í•˜ëŠ” ì‚¬ëŒì—ê²Œ ì°¾ì•„ì˜¨ë‹¤.", author: "â€” ë¦¬ ì•„ì´ì•„ì½”ì¹´" }
];

function renderFooters() {
  const quote = retirementQuotes[Math.floor(Math.random() * retirementQuotes.length)];
  const footerHTML = `
    <div class="footer-quote">"${quote.text}"</div>
    <div class="footer-author">${quote.author}</div>
    <div class="footer-copy">ë‚˜ì˜ ì€í‡´ ì‹œë®¬ë ˆì´í„° by ì«‘ì•„ë¹  Â· Â© 2026 All rights reserved.</div>
  `;
  ['footer-tab1','footer-tab2','footer-tab3','footer-tab4'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = footerHTML;
  });
}

init();

// PWA Service Worker ë“±ë¡
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}

// PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // ì„¤ì¹˜ ë°°ë„ˆ í‘œì‹œ
  const banner = document.createElement('div');
  banner.id = 'pwa-install-banner';
  banner.innerHTML = `
    <div style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:12px 20px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:flex;align-items:center;gap:12px;z-index:10000;font-size:0.9rem;">
      <span>ğŸ“² í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”!</span>
      <button onclick="installPWA()" style="background:white;color:var(--primary);border:none;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;white-space:nowrap;">ì„¤ì¹˜</button>
      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:rgba(255,255,255,0.7);cursor:pointer;font-size:1.2rem;">&times;</button>
    </div>`;
  document.body.appendChild(banner);
});

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(result => {
      deferredPrompt = null;
      const banner = document.getElementById('pwa-install-banner');
      if (banner) banner.remove();
    });
  }
}
</script>
</body>
</html>
